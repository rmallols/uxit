/* Minified js files! 2013-08-27 */
function LoginController($scope,$routeParams,globalMsgService){"use strict";$scope.error=$routeParams.error,$routeParams.error&&setTimeout(function(){globalMsgService.show("Invalid credentials"),$scope.$apply()},100)}function PortalController($scope,roleService,sessionService){"use strict";$scope.isAdmin=function(){return roleService.hasAdminRole(sessionService.getUserSession())}}COMPONENTS.directive("login",["sessionService",function(sessionService){"use strict";return{restrict:"E",replace:!0,templateUrl:"/client/html/login.html",scope:{},link:function(scope){scope.userSession=sessionService.getUserSession(),scope.logout=function(){sessionService.logout()}}}}]),COMPONENTS.directive("pages",["portalService","pageService","rowService","appService","roleService","sessionService","styleService",function(portalService,pageService,rowService,appService,roleService,sessionService,styleService){"use strict";return{restrict:"E",replace:!0,templateUrl:"/client/html/pages.html",link:function(scope){function isAppSortAndResizeAllowed(){return scope.isAdmin()&&!appService.isFullscreen()}scope.portal=portalService.getPortal(),scope.setPagesStyles=function(){return scope.portal?styleService.getNormalizedStyles(scope.portal.styles,null):null},scope.getAdminAccessStyleClass=function(){return roleService.getAdminAccessStyleClass()},scope.isAdmin=function(){return roleService.hasAdminRole(sessionService.getUserSession())},scope.isAppSortAllowed=function(){return isAppSortAndResizeAllowed()},scope.isAppResizeAllowed=function(){return isAppSortAndResizeAllowed()}}}}]),function(){"use strict";COMPONENTS.directive("addAppPanel",["availableAppsService","undeployService","constantsService","addAppService","crudService","keyboardService",function(availableAppsService,undeployService,constantsService,addAppService,crudService,keyboardService){return{restrict:"E",transclude:!0,templateUrl:"/client/html/admin/addAppPanel.html",replace:!0,link:function(scope,element){function registerKeyboardEvents(){keyboardService.register(["tab","down"],directiveId,function(){activeAppId=activeAppId<scope.availableApps.model.length-1?activeAppId+1:0,scope.$apply()}),keyboardService.register(["shift+tab","up"],directiveId,function(){activeAppId=activeAppId>0?activeAppId-1:scope.availableApps.model.length-1,scope.$apply()}),keyboardService.register("enter",directiveId,function(){scope.showExpandedView(scope.availableApps.model[activeAppId])})}var activeAppId=0,collapsedState="collapsed",expandedState="expanded",directiveId="addAppPanel";scope.showExpandedView=function(availableApp){function getStats(){var filter={cond:{targetId:scope.highlight._id}};crudService.getStats(constantsService.collections.comments,filter,function(stats){scope.highlight.stats=stats})}scope.onAddedComment=function(){getStats()},scope.highlight=availableApp,scope.highlight.collection=constantsService.collections.availableApps,element.attr("state",expandedState),getStats()},scope.hideExpandedView=function(){scope.highlight=null,element.attr("state",collapsedState)},scope.toggleExpandedView=function(availableApp){scope.highlight&&scope.highlight.id===availableApp.id?scope.hideExpandedView():scope.showExpandedView(availableApp)},scope.getBlockStyleClass=function(appId){return element.attr("state")===expandedState&&scope.highlight&&appId===scope.highlight.id?"highlight":""},scope.getAppClasses=function(appId){return appId===activeAppId?"hoverState":""},scope.undeploy=function(){undeployService.undeploy(scope.highlight),scope.hideExpandedView(),availableAppsService.loadAvailableApps(function(availableApps){scope.availableApps=availableApps})},scope.onAvailableAppDeployed=function(){availableAppsService.loadAvailableApps(function(availableApps){scope.availableApps=availableApps})},scope.collection=constantsService.collections.comments,scope.availableApps=availableAppsService.getAvailableApps(),registerKeyboardEvents()}}}])}(),function(){"use strict";COMPONENTS.directive("adminPanel",["$rootScope","$location","portalService","addAppService","mediaService","sessionService","keyboardService","$timeout",function($rootScope,$location,portalService,addAppService,mediaService,sessionService,keyboardService,$timeout){return{restrict:"E",transclude:!0,templateUrl:"/client/html/admin/adminPanel.html",replace:!0,scope:{},link:function(scope,element){function toggle(tabIndex){tabIndex!==currentTabIndex?show(tabIndex):(hide(),inactiveTab())}function toggleAddAppPanel(){hide(),addAppService.toggleAddAppPanel(),addAppService.isAddAppPanelActive()?keyboardService.register("esc",directiveId,function(){addAppService.hideAddAppPanel(),inactiveTab(),scope.$apply()}):inactiveTab()}function show(tabIndex){currentTabIndex=tabIndex,element.removeClass("hide").addClass("show"),addAppService.isAddAppPanelActive()&&addAppService.hideAddAppPanel(),$location.search({}),registerKeyboardEvents()}function hide(){currentTabIndex=null,element.removeClass("show").addClass("hide"),unregisterKeyboardEvents()}function inactiveTab(){$timeout(function(){scope.activeTab=-1},0)}function registerKeyboardEvents(){keyboardService.register("ctrl+a",directiveId,function(){scope.activeTab=0,toggleAddAppPanel(),scope.$apply()}),keyboardService.register("ctrl+enter",directiveId,function(){scope.onSave(),scope.$apply()}),keyboardService.register("esc",directiveId,function(){scope.onCancel(),scope.$apply()})}function unregisterKeyboardEvents(){keyboardService.unregister("ctrl+a",directiveId),keyboardService.unregister("ctrl+enter",directiveId),keyboardService.unregister("esc",directiveId)}var currentTabIndex,ngStyleAvatarFn,directiveId="adminPanel",userSession=sessionService.getUserSession();ngStyleAvatarFn=function(){return userSession?{backgroundImage:'url("'+mediaService.getDownloadUrl(userSession.media)+'")'}:null},scope.portal=portalService.getPortal(),scope.panels=[{title:"adminPanel.addApp",description:"adminPanel.addApp.desc",type:"addApp",ngClass:"addIcon",onTabClicked:toggleAddAppPanel},{title:"adminPanel.settings",description:"adminPanel.settings.desc",type:"editGeneral",ngClass:"settingsIcon",onTabClicked:toggle},{title:"adminPanel.styles",description:"adminPanel.styles.desc",type:"editStyles",ngClass:"stylesIcon",onTabClicked:toggle},{title:"adminPanel.content",description:"adminPanel.content.desc",type:"editContentList",ngClass:"contentIcon hideEditedMark",onTabClicked:toggle},{title:"adminPanel.users",description:"adminPanel.users.desc",type:"editUserList",ngClass:"userIcon hideEditedMark",onTabClicked:toggle},{title:"adminPanel.media",description:"adminPanel.media.desc",type:"editMediaList",ngClass:"mediaIcon hideEditedMark",onTabClicked:toggle},{title:"adminPanel.pages",description:"adminPanel.pages.desc",type:"editPages",ngClass:"pageIcon",onTabClicked:toggle},{title:"tags",description:"adminPanel.tags.desc",type:"editTagList",ngClass:"tagsIcon hideEditedMark",onTabClicked:toggle},{title:"adminPanel.notifications",description:"adminPanel.notifications.desc",type:"editNotifications",ngClass:"notificationsIcon",onTabClicked:toggle},{title:"adminPanel.stats",description:"adminPanel.stats.desc",type:"stats",ngClass:"statsIcon",onTabClicked:toggle},{title:"adminPanel.you",description:"adminPanel.you.desc",type:"editCurrentUser",ngStyle:ngStyleAvatarFn,onTabClicked:toggle}],inactiveTab(),scope.onCancel=function(){hide(),inactiveTab()},scope.onSave=function(){portalService.savePortal(function(){hide(),inactiveTab()})}}}}])}(),COMPONENTS.directive("createContent",["tagService",function(tagService){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editContent.html",scope:{content:"="},link:function(scope){scope.availableTags=tagService.getTags()}}}]),COMPONENTS.directive("createMedia",["tagService",function(tagService){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/createMedia.html",scope:{media:"="},link:function(scope){scope.multipleFilesUploaded=!1,scope.media=[],scope.availableTags=tagService.getTags(),scope.onUpload=function(uploadedMedia){scope.multipleFilesUploaded=uploadedMedia.length>1,scope.media=uploadedMedia},scope.getMultipleFilesUploadedNames=function(){var multipleFilesUploadedNames="";return scope.multipleFilesUploaded&&scope.media.forEach(function(media){multipleFilesUploadedNames+=media.name+", "}),multipleFilesUploadedNames}}}}]),COMPONENTS.directive("createUser",["$rootScope","$routeParams","mediaService","roleService","tagService","i18nService",function($rootScope,$routeParams,mediaService,roleService,tagService,i18nService){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editUser.html",scope:{user:"=",onLayerSave:"="},link:function(scope){scope.availableTags=tagService.getTags(),scope.roles=roleService.getRoles(),scope.languages=i18nService.getLanguages(),scope.defaultAvatarUrl=mediaService.getDefaultAvatarUrl(),scope.languages=$.extend(!0,[],i18nService.getLanguages()),scope.languages.unshift({code:"",text:i18nService("editUser.language.inheritBrowser")}),scope.user={role:1,language:scope.languages[0].code,media:{}}}}}]),function(){"use strict";COMPONENTS.directive("edit",["$rootScope","$compile","portalService","validationService","keyboardService","stringService",function($rootScope,$compile,portalService,validationService,keyboardService,stringService){return{restrict:"E",require:"ngModel",transclude:!0,templateUrl:"/client/html/admin/edit.html",replace:!0,scope:{model:"=ngModel",internalData:"=",panels:"=",onSave:"=",onChange:"=",onCancel:"=",activeTab:"=",limitLayerHeight:"@"},link:function(scope,element,attrs){function setPristine(){formObjs.forEach(function(formObj){formObj.$dirty=!1,formObj.$pristine=!0})}function updateFormObjs(){scope.panels.forEach(function(panel){formObjs.push(scope[panel.type])})}function registerKeyboardEvents(){keyboardService.register("left",directiveId,function(){var newActiveTab=scope.activeTab>0?scope.activeTab-1:scope.panels.length-1;scope.clickTab(newActiveTab),scope.$apply()}),keyboardService.register("right",directiveId,function(){var newActiveTab=scope.activeTab<scope.panels.length-1?scope.activeTab+1:0;scope.clickTab(newActiveTab),scope.$apply()})}function setTempScrollingStyleClass(){var scrollingStyleClass="scrolling";element.addClass(scrollingStyleClass),setTimeout(function(){element.removeClass(scrollingStyleClass)},window.speed)}var directiveId="edit"+(attrs.type?"-"+attrs.type:""),i=0,pristineModel={},pristineInternalData={},formObjs=[],layersWrapper=$("> .content.level1 > ul",element);scope.showIfMultipleTabs=function(){return scope.panels.length>1},scope.getLayerHeight=function(){return scope.limitLayerHeight?{height:.5*$(window).height()}:null},scope.cancel=function(){$.extend(!0,scope.model,pristineModel),$.extend(!0,scope.internalData,pristineInternalData),scope.onCancel&&scope.onCancel(),updateFormObjs(),setPristine()},scope.save=function(){function save(){var processedPanels=0;scope.panels.forEach(function(panel){panel.onLayerSave?panel.onLayerSave(function(){processedPanels+=1,processedPanels===scope.panels.length&&scope.onSave()}):(processedPanels+=1,processedPanels===scope.panels.length&&scope.onSave())})}updateFormObjs(),validationService.isFormValid(formObjs)&&scope.onSave?(save(),$.extend(!0,pristineModel,scope.model),$.extend(!0,pristineInternalData,scope.internalData),setPristine()):validationService.setFocusOnFirstError(element)},scope.clickTab=function(tabIndex){scope.activeTab=tabIndex,scope.panels[tabIndex].onTabClicked&&scope.panels[tabIndex].onTabClicked(tabIndex),layersWrapper.css("margin-left","-"+100*tabIndex+"%"),setTempScrollingStyleClass()},scope.getTabClasses=function(panel,tabIndex){return tabIndex===scope.activeTab?"active "+panel.ngClass:panel.ngClass},scope.isLayerShown=function(tabIndex){return tabIndex===scope.activeTab},scope.isEditedMarkVisible=function(panelForm){return scope.activeTab>=0&&panelForm.$dirty},scope.getEditedMarkColor=function(panelForm){return panelForm.$valid?"valid":"invalid"},scope.$watch("model",function(newVal){newVal&&$.extend(!0,pristineModel,scope.model)}),scope.$watch("internalData",function(newVal){newVal&&$.extend(!0,pristineInternalData,scope.internalData)}),scope.$watch("panels",function(){scope.tabWidth=100/scope.panels.length,scope.panels[0].active=!0,angular.forEach(scope.panels,function(panel){var directiveName=stringService.toSnakeCase(panel.type),html='<li class="layer" ng-form name="'+panel.type+'">'+'<div id="'+panel.type+scope.$id+'" '+directiveName+" "+'model="model" ng-style="getLayerHeight()" internal-data="internalData" '+'on-cancel="onCancel" on-change="onChange" on-layer-save="panels['+i+'].onLayerSave" '+'ux-show="isLayerShown('+i+')" persist="true"></div>'+"</li>",directiveElement=$compile(html)(scope);panel.active&&(scope.activePanel=panel),layersWrapper.append(directiveElement),i+=1})}),registerKeyboardEvents()}}}])}(),COMPONENTS.directive("editAppGeneral",["i18nService",function(i18nService){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editAppGeneral.html",scope:{model:"=",onLayerSave:"="},link:function(scope){scope.aligns=[{id:"left",text:i18nService("editApp.alignLeft")},{id:"center",text:i18nService("editApp.alignCenter")},{id:"right",text:i18nService("editApp.alignRight")}],scope.model.align||(scope.model.align=scope.aligns[0].id)}}}]),COMPONENTS.directive("editAppStyles",[function(){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editAppStyles.html",scope:{model:"=",onLayerSave:"="}}}]),function(){"use strict";COMPONENTS.directive("editBox",["editBoxUtilsService","keyboardService",function(editBoxUtilsService,keyboardService){return{restrict:"E",transclude:!0,templateUrl:"/client/html/admin/editBox.html",replace:!0,scope:{model:"=",internalData:"=",panels:"=",onSave:"=",onChange:"=",onCancel:"=",onClose:"=",target:"=",arrowPos:"="},link:function(scope,element){function registerKeyboardEvents(){keyboardService.register("ctrl+enter",directiveId,function(){scope.save(),scope.$apply()}),keyboardService.register("esc",directiveId,function(){scope.cancel(),scope.$apply()})}var arrowPosOptions={top:"top",right:"right",bottom:"bottom",left:"left"},directiveId="editBox";scope.activeTab=0,scope.getStyles=function(){var topPos=scope.target.coordinates.top+scope.target.coordinates.height/2,leftPos=scope.arrowPos===arrowPosOptions.left?scope.target.coordinates.width+scope.target.coordinates.left:-(element.width()+scope.target.coordinates.width)+scope.target.coordinates.left;return{top:topPos,left:leftPos}},scope.save=function(){editBoxUtilsService.hideEditBox(scope.$id),scope.onSave&&scope.onSave(scope.model,scope.$id),scope.onClose&&scope.onClose()},scope.change=function(){scope.onChange&&scope.onChange(scope.model,scope.$id)},scope.cancel=function(){editBoxUtilsService.hideEditBox(scope.$id),scope.onCancel&&scope.onCancel(),scope.onClose&&scope.onClose()},registerKeyboardEvents()}}}])}(),COMPONENTS.directive("editContent",["contentService","tagService",function(contentService,tagService){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editContent.html",scope:{content:"=model",onLayerSave:"="},link:function(scope){scope.availableTags=tagService.getTags(),scope.onLayerSave=function(callback){contentService.updateContent(scope.content,function(){callback()})}}}}]),COMPONENTS.directive("editContentList",[function(){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editContentList.html",scope:{},controller:["$scope",function($scope){$scope.config={editable:!0,selectable:!0,multiSelectable:!0,uploadable:!0,deletable:!0}}]}}]),COMPONENTS.directive("editCurrentUser",["$rootScope","userService","sessionService",function($rootScope,userService,sessionService){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editCurrentUser.html",scope:{model:"=",onLayerSave:"="},link:function(scope){scope.userSession=sessionService.getUserSession(),scope.onLayerSave=function(callback){userService.updateUser(scope.currentUser,function(){callback()})},scope.logout=function(){sessionService.logout()}}}}]),function(COMPONENTS){"use strict";COMPONENTS.directive("editGeneral",["portalService","mediaService",function(portalService,mediaService){return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editGeneral.html",scope:{model:"="},link:function(scope){scope.$watch("model.title",function(){portalService.setHeader()}),scope.level2Tabs=[{title:"editGeneral.general",styleClass:"settingsIcon"},{title:"editGeneral.app",styleClass:"appIcon"},{title:"editGeneral.comments",styleClass:"commentsIcon"},{title:"editGeneral.email",styleClass:"notificationsIcon"},{title:"editGeneral.analytics",styleClass:"statsIcon"}],scope.defaultFaviconUrl=portalService.getDefaultFaviconUrl(),mediaService.getMediaFromId(scope.model.faviconId,function(favicon){scope.favicon=favicon}),scope.updateFavicon=function(newFavicon){scope.model.faviconId=newFavicon[0]._id}}}}])}(window.COMPONENTS),COMPONENTS.directive("editMedia",["mediaService","tagService",function(mediaService,tagService){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editMedia.html",scope:{media:"=model",onLayerSave:"="},link:function(scope){scope.availableTags=tagService.getTags(),scope.onLayerSave=function(callback){mediaService.updateMedia(scope.media,function(){callback()})},scope.onUpload=function(uploadedMedia){scope.media.name="",setTimeout(function(){scope.media.name=uploadedMedia[0].name,scope.$apply()},0)}}}}]),COMPONENTS.directive("editMediaList",[function(){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editMediaList.html",scope:{},controller:["$scope",function($scope){$scope.refreshList=function(){},$scope.config={editable:!0,selectable:!0,multiSelectable:!0,uploadable:!0,deletable:!0}}]}}]),function(COMPONENTS){"use strict";COMPONENTS.directive("editNotifications",["emailService","stdService","userService","liveMessageService",function(emailService,stdService,userService,liveMessageService){return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editNotifications.html",scope:{model:"=",onLayerSave:"="},link:function(scope){function sendEmail(callback){if(scope.model.notifications.email&&scope.model.notifications.email.subject&&scope.model.notifications.email.text&&scope.model.notifications.email.selectedUsers.length>0){var data={subject:scope.model.notifications.email.subject,text:scope.model.notifications.email.text,to:scope.model.notifications.email.selectedUsers.join(",")};emailService.sendEmail(data,function(result){result?callback():stdService.error("There was an error sending the e-mail")})}callback()}function sendLiveMessage(callback){if(scope.model.notifications.liveMessage&&scope.model.notifications.liveMessage.subject&&scope.model.notifications.liveMessage.text){var data={text:scope.model.notifications.liveMessage.subject,details:scope.model.notifications.liveMessage.text};liveMessageService.sendPublicMessage(data,function(result){result?callback():stdService.error("There was an error sending the live message")})}callback()}scope.usersList=userService.getUsers(),scope.level2Tabs=[{title:"editNotifications.email",styleClass:"notificationsIcon"},{title:"editNotifications.liveMessage",styleClass:"infoIcon"}],scope.onLayerSave=function(callback){sendEmail(function(){sendLiveMessage(function(){scope.model.notifications={},callback()})})}}}}])}(window.COMPONENTS),function(COMPONENTS){"use strict";COMPONENTS.directive("editPages",["$rootScope","$routeParams","$location","portalService","pageService","validationService","$timeout","stringService","timerService","stdService","arrayService","constantsService","i18nService","i18nDbService",function($rootScope,$routeParams,$location,portalService,pageService,validationService,$timeout,stringService,timerService,stdService,arrayService,constantsService,i18nService,i18nDbService){return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editPages.html",scope:{onLayerSave:"="},link:function(scope){function getCurrentPageIndex(){var i,currentPage=pageService.getCurrentPage();for(i=0;i<scope.pages.length&&scope.pages[i]._id!==currentPage._id;i+=1);return i}function savePages(callback){function registerAndFinish(){processedPages+=1,processedPages===scope.pages.length&&callback()}function saveCallback(page){saveItems(page),registerAndFinish()}function createPage(data,page){delete data.added,pageService.createPage(data,function(){saveCallback(page)})}function deletePage(data,page){delete data.deleted,pageService.deletePage(page._id,function(){saveCallback(page)})}function updatePage(data,page){delete data.updated,pageService.updatePage(page._id,data,function(){saveCallback(page)})}function saveItems(parentItem){var items=parentItem?parentItem.items:scope.items;items.forEach(function(page){var data=$.extend(!0,{},page);data.parentPageId=parentItem?parentItem._id:null,delete data.areSubItemsHidden,delete data._id,delete data.items,data.added?createPage(data,page):data.deleted?deletePage(data,page):data.updated?updatePage(data,page):saveCallback(page)})}var processedPages=0;saveItems(null)}scope.updateSelectedPageUrl=function(){var url;scope.selectedPage&&(url=stringService.replaceToken(i18nDbService.getI18nProperty(scope.selectedPage.text).text," ","-"),scope.selectedPage.url=stringService.toCamelCase(url)),scope.registerSelectedPageChange()},scope.registerSelectedPageChange=function(){scope.selectedPage&&(scope.selectedPage.updated=!0)},scope.onAddPage=function($page){$page.type=scope.pageTypes[0].id,$timeout(function(){scope.updateSelectedPageUrl()},0)},scope.onLayerSave=function(callback){savePages(function(){var currentPageIndex=getCurrentPageIndex();$location.path($routeParams.portal+"/"+scope.pages[currentPageIndex].url),callback()})},scope.pageTypes=[{id:constantsService.pageTypes.apps,text:constantsService.pageTypes.apps},{id:constantsService.pageTypes.externalLink,text:constantsService.pageTypes.externalLink}],scope.targets=[{id:"_blank",text:i18nService("editPages.target.newTab")},{id:"_self",text:i18nService("editPages.target.sameTab")}],scope.level2Tabs=[{title:"General"},{title:"Section 2"},{title:"Section 3"}]}}}])}(window.COMPONENTS),COMPONENTS.directive("editStyles",[function(){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/editStyles.html",scope:{model:"=",onLayerSave:"="},link:function(scope){scope.level2Tabs=[{title:"editStyles.portal",styleClass:"webIcon"},{title:"editStyles.app",styleClass:"appIcon"}]}}}]),COMPONENTS.directive("editTag",["tagService",function(tagService){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editTag.html",scope:{tag:"=model",onLayerSave:"="},link:function(scope){scope.onLayerSave=function(callback){tagService.updateTag(scope.tag,function(){callback()})}}}}]),COMPONENTS.directive("editTagList",[function(){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editTagList.html",scope:{},controller:["$scope",function($scope){$scope.config={editable:!0,selectable:!0,multiSelectable:!0,uploadable:!0,deletable:!0}}]}}]),COMPONENTS.directive("editUser",["$routeParams","userService","mediaService","tagService","roleService","i18nService",function($routeParams,userService,mediaService,tagService,roleService,i18nService){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editUser.html",scope:{user:"=model",onLayerSave:"="},link:function(scope){scope.availableTags=tagService.getTags(),scope.roles=roleService.getRoles(),scope.languages=$.extend(!0,[],i18nService.getLanguages()),scope.languages.unshift({code:"",text:i18nService("editUser.language.inheritBrowser")}),scope.user&&(scope.user.media||(scope.user.media={})),scope.user&&scope.user.media||(scope.defaultAvatarUrl=mediaService.getDefaultAvatarUrl()),scope.onLayerSave=function(callback){userService.updateUser(scope.user,function(result){callback(result)})}}}}]),COMPONENTS.directive("editUserList",[function(){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/editUserList.html",scope:{},controller:["$scope",function($scope){$scope.config={editable:!0,selectable:!0,multiSelectable:!0,uploadable:!0,deletable:!0}}]}}]),COMPONENTS.directive("richContent",["crudService","constantsService","textSelectionService","domService",function(crudService,constantsService,textSelectionService){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/richContent.html",scope:{model:"=",onChange:"="},link:function(scope){function getSelectedLink(){var linkObj=textSelectionService.getSelectedLinkDomObj();scope.selectedPageId=linkObj.attr("id")}function setHeadingOptions(){scope.headingOptions=[{value:"16px",text:"Normal"},{value:"55px",text:"Title 1"},{value:"40px",text:"Title 2"},{value:"25px",text:"Title 3"}]}function getPagesList(){scope.pagesList=[];var params={projection:{text:1,url:1}};crudService.get(constantsService.collections.pages,null,params,function(pagesList){$.each(pagesList.results,function(index,page){scope.pagesList.push(page)})})}scope.propagateChanges=function(){scope.onChange&&scope.onChange()},scope.changeLink=function(){scope.selectedPageId&&textSelectionService.setLink({id:scope.selectedPageId,href:scope.selectedPageId,title:"/"+scope.selectedPageId,target:"_self"})},getSelectedLink(),setHeadingOptions(),getPagesList()}}}]),COMPONENTS.directive("toggleStyle",["$timeout",function($timeout){"use strict";return{restrict:"A",replace:!0,template:'<button ng-click="toggleState()" ng-class="{active:isActive()}" on-change="onChange"></button>',scope:{model:"=ngModel",onChange:"="},link:function(scope,element,attrs){scope.toggleState=function(){scope.model=scope.isActive()?attrs.inactiveWhen||"":attrs.activeWhen,$timeout(function(){scope.onChange&&scope.onChange()},0)},scope.isActive=function(){return scope.model===attrs.activeWhen}}}}]),COMPONENTS.directive("stats",["$rootScope","crudService","roleService","constantsService",function($rootScope,crudService,roleService,constantsService){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/admin/stats.html",scope:{},link:function(scope){function normalizeTimeTmpDelete(stats){stats.forEach(function(stat){stat["create.date"]||(stat["create.date"]="2013-04-01T22:00:00.000Z")})}function normalizeUserData(stats){var normalizedData=[];return stats.forEach(function(stat){normalizedData.push({label:stat.create.author?stat.create.author.fullName:void 0,value:stat.count})}),normalizedData}function normalizeUsersPerRoleData(stats){var roleObj,normalizedData=[];return stats.forEach(function(stat){roleObj=roleService.getRole(stat.role),normalizedData.push({label:roleObj?roleObj.title:"undefined",value:stat.count})}),normalizedData}var filter;crudService.getStats(constantsService.collections.content,{},function(stats){normalizeTimeTmpDelete(stats),scope.newsPerDay=stats}),crudService.getStats(constantsService.collections.users,{},function(stats){normalizeTimeTmpDelete(stats),scope.usersPerDay=stats}),filter={groupBy:"create.authorId"},crudService.getStats(constantsService.collections.content,filter,function(stats){scope.contentPerUser=normalizeUserData(stats)}),filter={groupBy:"role"},crudService.getStats(constantsService.collections.users,filter,function(stats){scope.usersPerRole=normalizeUsersPerRoleData(stats)}),filter={groupBy:"create.authorId"},crudService.getStats(constantsService.collections.comments,filter,function(stats){scope.commentsPerUser=normalizeUserData(stats)})}}}]),COMPONENTS.directive("styles",[function(){"use strict";return{restrict:"A",replace:!0,templateUrl:"/client/html/admin/styles.html",scope:{model:"=styles"},link:function(){}}}]),COMPONENTS.directive("verticalTabs",[function(){"use strict";return{restrict:"A",replace:!0,transclude:!0,template:'<ul class="tabs level2"><li class="button {{tab.styleClass}}" ng-repeat="tab in tabs" ng-class="isCurrentLayer($index)" ng-click="setCurrentLayer($index)"><label i18n="{{tab.title}}"></label></li></ul>',scope:{tabs:"=verticalTabs"},link:function(scope){scope.isCurrentLayer=function(layer){return layer===scope.activePanel?"active":null},scope.setCurrentLayer=function(tabIndex){scope.activePanel=tabIndex,$(".content.level2 > ul").css("top","-"+100*tabIndex+"%")},scope.activePanel=0}}}]),function(){"use strict";COMPONENTS.directive("app",["$rootScope","$compile","portalService","styleService","appService","availableAppsService","constantsService","stringService","roleService",function($rootScope,$compile,portalService,styleService,appService,availableAppsService,constantsService,stringService,roleService){return{restrict:"A",replace:!0,templateUrl:"/client/html/app/app.html",scope:{_id:"=app",type:"=",model:"=",width:"=",templateApp:"@"},link:function(scope,element){function initModel(){var availableApps;availableApps=availableAppsService.getAvailableApps(),scope.appInfo=getModelFromIndex(availableApps,scope.type),!scope.model&&scope.appInfo&&(scope.model=scope.appInfo.defaultModel||{}),scope.internalData={},scope.setViewTemplate(),scope.getAppStyleSheet(),element.addClass(scope.type)}function getModelFromIndex(array,matcher){return array?array.model[array.index[matcher]]:null}var hasWidthChanged=!1;scope.setViewTemplate=function(){var directiveName=stringService.toSnakeCase(scope.type),template="<div "+directiveName+'-view id="_id" model="model" '+'internal-data="internalData" on-layer-save="onLayerSave" on-resized="onResized"></div>',compiledTemplates=$compile(template)(scope);$("> .content > [data]",element).html("").append(compiledTemplates)},scope.setAppStyles=function(){if(scope.model&&portalService.getPortal()){var styles=styleService.getNormalizedStyles(portalService.getPortal().app.styles,null);return styles=styleService.getNormalizedStyles(scope.model.styles,styles)}return null},scope.isTitleVisible=function(){var portal=portalService.getPortal();return scope.model&&void 0!==scope.model.showTitle?scope.model.showTitle:portal.app?portal.app.showTitle:!1},scope.getAppStyleSheet=function(){var appPath=constantsService.appsPath+"/"+scope.type+"/",sheetName=scope.type+".less",sheetPath=appPath+sheetName,link=$('<link rel="stylesheet" type="text/less" href="'+sheetPath+'" />');less.sheets.push(link[0]),less.refresh()},scope.removeApp=function(){element.hide("explode",{direction:"horizontal"},window.speed,function(){appService.isFullscreen()&&appService.disableFullscreen(element,scope.onResized),portalService.deleteApp(element,scope.$parent.$index),$(this).remove()})},scope.getAdminAccessStyleClass=function(){return roleService.getAdminAccessStyleClass()},scope.$watch("type",function(newVal){newVal&&initModel()}),scope.$watch("width",function(newVal){newVal&&(hasWidthChanged?appService.triggerOnResizeEvent(scope.onResized):hasWidthChanged=!0)}),$rootScope.$on(constantsService.collections.availableApps+"Undeployed",function(event,type){type===scope.type&&scope.removeApp()}),element.mouseenter(function(){element.addClass("hover")}),element.mouseleave(function(){element.removeClass("hover")})}}}])}(),function(){"use strict";COMPONENTS.directive("appHeader",["$rootScope","$location","appService","portalService","pageService","roleService","sessionService","stringService","editBoxUtilsService",function($rootScope,$location,appService,portalService,pageService,roleService,sessionService,stringService,editBoxUtilsService){return{restrict:"A",replace:!0,templateUrl:"/client/html/app/appHeader.html",link:function(scope,element){function getEditPanels(){return scope.appInfo.editPanels?getCustomEditPanels():getDefaultEditPanels()}function getDefaultEditPanels(){var panels=[];return scope.appInfo.noCustomEditPanel||panels.push({title:"Edit",type:scope.type+"Edit"}),panels.push({title:"Edit App",type:"editAppGeneral"},{title:"Styles setup",type:"editAppStyles"}),panels}function getCustomEditPanels(){var panelType,defaultEditPanels,panels=[];return scope.appInfo.editPanels.forEach(function(panel){panelType=scope.type+stringService.capitalize(panel.type),panels.push({title:panel.title,type:panelType,styleClass:panel.type})
}),defaultEditPanels=getDefaultEditPanels(),defaultEditPanels.forEach(function(panel){panels.push(panel)}),panels}function enableFullscreen(){appService.enableFullscreen(appElm,scope._id,scope.width,scope.onResized)}function disableFullscreen(){appService.disableFullscreen(appElm,scope.onResized)}function manageFullscreenFromSearch(){Number($location.search()._id)===scope._id?enableFullscreen():$location.search()._id||disableFullscreen()}function toggleHeader(){$(".app").not(appElm).removeClass("enabledHeader"),appElm.toggleClass("enabledHeader")}function hideHeader(){appElm.removeClass("enabledHeader")}var appElm=element.parent(),userSession=sessionService.getUserSession();scope.showHeader=function(){return userSession},scope.showEditActions=function(){return userSession&&roleService.hasCreatorRole(userSession)},scope.showAdminActions=function(){return userSession&&roleService.hasAdminRole(userSession)},scope.toggleHeader=function(){toggleHeader()},scope.isAdmin=function(){return roleService.hasAdminRole(userSession)},scope.getAppHelpText=function(){if(scope.model&&scope.appInfo&&scope.appInfo.desc){var title="<h6>"+(scope.model.title||scope.appInfo.title)+" app</h6>",desc=scope.appInfo.desc;return title+desc}return null},scope.toggleFullscreen=function(){appService.isFullscreen()?disableFullscreen():enableFullscreen(),hideHeader()},scope.showEditTemplate=function(){var targetObj=$("> .header > .actions > .editIcon",element);scope.panels=getEditPanels(),scope.onSave=function(){scope.onLayerSave&&scope.onLayerSave(),pageService.updateCurrentPage(null),portalService.savePortal(null)},editBoxUtilsService.showEditBox(scope,targetObj,targetObj)},$rootScope.$on("onWindowResized",function(){appService.triggerOnResizeEvent(scope.onResized)}),scope.isTemplateFullscreen=portalService.isTemplateFullscreen(),$rootScope.$on("onPortalSaved",function(){scope.isTemplateFullscreen=portalService.isTemplateFullscreen()}),manageFullscreenFromSearch(),scope.$on("$routeUpdate",function(){manageFullscreenFromSearch()})}}}])}(),COMPONENTS.directive("lineChart",["sessionService",function(sessionService){"use strict";return{restrict:"E",replace:!0,template:' <div class="lineChart chart" ng-style="getChartSize()" ng-show="data.length > 0"></div>',scope:{data:"="},link:function(scope,element){var elmWidth=element.width();scope.$watch("data",function(newVal,oldVal){sessionService.isUserLogged()&&newVal&&newVal!==oldVal&&(element.html(""),scope.data.length>0&&new Morris.Line({element:element,data:scope.data,xkey:"create.date",ykeys:["count"],labels:["count"],lineColors:["#32b4e4"]}))},!0),scope.getChartSize=function(){return{width:elmWidth,height:.45*elmWidth}}}}}]),COMPONENTS.directive("pieChart",["sessionService",function(sessionService){"use strict";return{restrict:"E",replace:!0,template:' <div class="pieChart chart" ng-style="getChartSize()" ng-show="data.length > 0"></div>',scope:{data:"="},link:function(scope,element){var elmWidth=element.width();scope.$watch("data",function(newVal,oldVal){sessionService.isUserLogged()&&newVal&&newVal!==oldVal&&(element.html(""),scope.data.length>0&&new Morris.Donut({element:element,data:scope.data}))},!0),scope.getChartSize=function(){var boxSize=.6*elmWidth,marginLeft=(elmWidth-boxSize)/2;return{width:boxSize,height:boxSize,marginLeft:marginLeft}}}}}]),function(){"use strict";COMPONENTS.directive("comment",["$compile","portalService","dateService","stringService","mediaService","crudService","constantsService",function($compile,portalService,dateService,stringService,mediaService,crudService,constantsService){return{restrict:"A",replace:!0,scope:{comment:"="},templateUrl:"/client/html/comments/comment.html",link:function(scope,element){function deleteComment(comment){crudService.delete(constantsService.collections.comments,comment._id,function(){comment.deleted=!0})}function deleteCommentRecursively(comment){comment.comments&&comment.comments.length&&comment.comments.forEach(function(comment){deleteCommentRecursively(comment)}),deleteComment(comment)}var repliesHtml='<comments target-id="comment._id" parent-comment="comment" hide-add="hideAdd" placeholder="comments.addReply.placeholder"></comments>';$(".repliesWrapper",element).replaceWith($compile(repliesHtml)(scope)),scope.hideAdd=!0,scope.comment.isEditable=!1,scope.getDownloadUrl=function(media){return media?mediaService.getDownloadUrl(media):!1},scope.getFormattedDate=function(date){return dateService.getFormattedDate(date)},scope.showRatings=function(){return stringService.isEmpty(scope.allowRatings)?portalService.getPortal().comments.allowRatings:scope.allowRatings},scope.toggleReply=function(){scope.hideAdd=scope.hideAdd!==!0},scope.toggleEdit=function(){scope.comment.isEditable=scope.comment.isEditable!==!0},scope.updateComment=function(){crudService.update(constantsService.collections.comments,scope.comment._id,{text:scope.comment.text})},scope.deleteComment=function(){deleteCommentRecursively(scope.comment)}}}}])}(),function(){"use strict";COMPONENTS.directive("comments",["crudService","sessionService","i18nService","constantsService",function(crudService,sessionService,i18nService,constantsService){return{restrict:"E",replace:!0,scope:{targetId:"=",onAdd:"=",allowRatings:"=",parentComment:"=",hideAdd:"=",placeholder:"@"},templateUrl:"/client/html/comments/comments.html",link:function(scope){scope.$watch("targetId",function(newVal){if(newVal){var filter={q:{targetId:scope.targetId},sort:{field:"create.date",order:"-1"}};crudService.get(constantsService.collections.comments,null,filter,function(comments){scope.comments=comments.results,scope.parentComment&&(scope.parentComment.comments=scope.comments)})}}),scope.createComment=function(){var data={text:scope.newCommentText,targetId:scope.targetId};crudService.create(constantsService.collections.comments,data,function(newComment){scope.newCommentText="",sessionService.addSessionDataToModel(newComment),scope.comments.push(newComment),void 0!==scope.hideAdd&&(scope.hideAdd=!0),scope.onAdd&&scope.onAdd()})}}}}])}(),COMPONENTS.directive("globalMsg",["globalMsgService","domService",function(globalMsgService,domService){"use strict";return{restrict:"A",replace:!0,scope:{},template:'<div id="globalMsg" ng-class="getActiveStyleClass()"><div class="text"><label>{{globalMsg.text}}</label> <a href="#" ng-show="globalMsg.details" ng-click="toggleDetails()">[Details]</a><div class="details" ng-show="isDetailsVisible"><label>{{globalMsg.details}}</label></div></div><div class="actions"><button class="removeIcon" ng-click="hide()"></button></div></div>',link:function(scope){globalMsgService.onShow(function(text,details){scope.globalMsg||(scope.globalMsg={text:text,details:details},domService.removeLoadingFeedback($("body")))}),globalMsgService.onHide(function(){delete scope.globalMsg}),scope.isDetailsVisible=!1,scope.hide=function(){globalMsgService.hide()},scope.getActiveStyleClass=function(){return scope.globalMsg?"active":""},scope.toggleDetails=function(){scope.isDetailsVisible=scope.isDetailsVisible===!1}}}}]),function(undefined){"use strict";COMPONENTS.directive("title",["$rootScope","i18nService","i18nDbService",function($rootScope,i18nService,i18nDbService){return{restrict:"A",link:function(scope,element,attrs){function setTitle(newTitle){if(attrs.i18nTitle!==undefined)element.data("powertip",i18nService(newTitle));else if(attrs.i18nDbTitle!==undefined)try{element.data("powertip",i18nDbService.getI18nProperty(jQuery.parseJSON(newTitle)).text)}catch(ex){element.data("powertip",newTitle)}else element.data("powertip",newTitle)}attrs.$observe("title",function(newVal){newVal&&""!==newVal&&(element.data("powertip")||element.powerTip({smartPlacement:!0,mouseOnToPopup:"true"===attrs.keepTitleOnTooltipHover}),setTitle(newVal))}),$rootScope.$on("languageChanged",function(){setTitle(attrs.title)})}}}])}(window.undefined),function(){"use strict";COMPONENTS.directive("i18n",["$rootScope","i18nService",function($rootScope,i18nService){return{restrict:"A",replace:!0,scope:{i18n:"@"},template:"<label>{{label}}</label>",link:function(scope){function setLabelValue(){scope.label=i18nService(scope.i18n)}scope.$watch("i18n",function(){setLabelValue()}),$rootScope.$on("languageChanged",function(){setLabelValue()})}}}])}(),function(){"use strict";COMPONENTS.directive("i18nDb",["$rootScope","i18nService","i18nDbService",function($rootScope,i18nService,i18nDbService){return{restrict:"A",replace:!0,scope:{i18nDb:"="},template:'<label ng-bind-html-unsafe="label.text"></label>',link:function(scope){function updateLabel(){scope.i18nDb&&(scope.label=i18nDbService.getI18nProperty(scope.i18nDb))}updateLabel(),scope.$watch("i18nDb",function(){updateLabel()}),$rootScope.$on("languageChanged",function(){updateLabel()})}}}])}(),function(){"use strict";COMPONENTS.directive("i18nDbInput",["$rootScope","$compile","i18nService","i18nDbService","stringService","objectService",function($rootScope,$compile,i18nService,i18nDbService,stringService,objectService){var i18nPreffix="_i18n_";return{priority:1e3,restrict:"A",replace:!0,transclude:"element",controller:["$scope","$element","$attrs","$transclude","$compile",function($scope,$element,$attrs,$transclude,$compile){this.i18nNgModel=stringService.replaceToken(i18nPreffix+$attrs.ngModel,"\\.","_"),$element.removeAttr("i18n-db-input"),$element.attr("ng-model",this.i18nNgModel+".text"),$compile($element)($scope)}],template:"<input />",link:function(scope,element,attrs,controller){function updateModel(newVal){currentLanguage=i18nService.getCurrentLanguage(),hasI18nStructure=i18nDbService.hasI18nStructure(newVal),setOriginalModelPointers(newVal,hasI18nStructure),hasI18nStructure||initI18nStructure(newVal),updateNgModel(newVal),hasI18nStructure=!0}function updateNgModel(newVal){currentLanguage===defaultLanguage||creatingFromCustomLanguage?updateEditableNgModel(defaultLanguage):i18nDbService.hasI18nStructure(newVal)?updateEditableNgModel(currentLanguage):updateReadonlyNgModel()}function updateEditableNgModel(language){scope[controller.i18nNgModel]=originalModelLeafPointer[language],isDisabled=!1,element.removeAttr("readonly")}function updateReadonlyNgModel(){scope[controller.i18nNgModel]=originalModelLeafPointer[defaultLanguage],isDisabled=!0,element.attr("readonly","readonly")}function initLeafStructure(){originalModelParentLeafPointer[leafProp]={},originalModelParentLeafPointer[leafProp][defaultLanguage]={},originalModelLeafPointer=originalModelParentLeafPointer[leafProp]}function initDefaultLanguageStructure(newVal){originalModelLeafPointer[defaultLanguage]={},originalModelLeafPointer[defaultLanguage].text=newVal}function initI18nStructure(newVal){objectService.isObject(newVal)?creatingFromCustomLanguage=!1:(initLeafStructure(),initDefaultLanguageStructure(newVal),currentLanguage!==defaultLanguage&&(creatingFromCustomLanguage=!0))}function setOriginalModelPointers(newVal,hasI18nStructure){hasI18nStructure?setOriginalModelModifiedPointers(newVal):setOriginalModelInitPointers()}function setOriginalModelInitPointers(){scope[ngModelLevels[0]]||(scope[ngModelLevels[0]]={}),scope[i18nPreffix+ngModelLevels[0]]={},originalModelLeafPointer=scope[ngModelLevels[0]];for(var i=1;i<ngModelLevels.length;i+=1)originalModelLeafPointer[ngModelLevels[i]]||(originalModelLeafPointer[ngModelLevels[i]]={}),originalModelParentLeafPointer=originalModelLeafPointer,originalModelLeafPointer=originalModelLeafPointer[ngModelLevels[i]],i===ngModelLevels.length-1&&(leafProp=ngModelLevels[i])}function setOriginalModelModifiedPointers(newVal){originalModelLeafPointer=newVal}var hasI18nStructure,isDisabled,originalModelLeafPointer,originalModelParentLeafPointer,leafProp,currentLanguage,creatingFromCustomLanguage,defaultLanguage=i18nService.getDefaultLanguage(),ngModelLevels=attrs.ngModel.split(".");setTimeout(function(){element.click(function(){currentLanguage=i18nService.getCurrentLanguage(),isDisabled&&(isDisabled=!1,$(this).removeAttr("readonly"),originalModelLeafPointer[currentLanguage]={},originalModelLeafPointer[currentLanguage].text=originalModelLeafPointer[defaultLanguage].text,scope[controller.i18nNgModel]=originalModelLeafPointer[currentLanguage],scope.$apply())})}),scope.$watch(attrs.ngModel,function(newVal){updateModel(newVal)}),$rootScope.$on("languageChanged",function(e,newLanguage){currentLanguage=newLanguage,updateNgModel(scope.$eval(attrs.ngModel))})}}}])}(),COMPONENTS.directive("autoComplete",["$rootScope","crudService","constantsService","i18nService","i18nDbService",function($rootScope,crudService,constantsService,i18nService,i18nDbService){"use strict";return{restrict:"E",replace:!0,template:'<div class="autoCompleteContainer"><input type="hidden" /></div>',require:"?ngModel",scope:{model:"=ngModel",options:"=ngOptions",multiple:"@",placeholder:"@",labelKey:"@",valueKey:"@",onChange:"=uxChange"},link:function(scope,element,attrs,ctrl){function updateModel(newVal){scope.model=newVal,ctrl.$setViewValue(scope.model),$rootScope.$$phase||scope.$apply()}var autoCompleteObj=$(' > input[type="hidden"]',element);attrs.valueKey||(attrs.valueKey="_id"),autoCompleteObj.on("change",function(e){e.added&&e.added.newItem?(delete e.added.newItem,crudService.create(constantsService.collections.tags,{text:e.added.text},function(newTag){e.val[e.val.length-1]=newTag[attrs.valueKey],updateModel(e.val)})):updateModel(e.val.length>0?e.val:void 0),scope.onChange&&scope.onChange()}),scope.$watch("options",function(newVal){if(scope.model&&ctrl.$setViewValue(scope.model),newVal&&newVal.length>0){var setup={data:{results:scope.options,text:function(item){var labelKey=i18nDbService.getI18nProperty(item[attrs.labelKey]).text;return labelKey||""}},multiple:"true"===attrs.multiple,placeholder:i18nService(attrs.placeholder),minimumInputLength:0,id:function(item){return item[attrs.valueKey]},createSearchChoice:function(term,data){if(0===$(data).filter(function(){var labelKey=i18nDbService.getI18nProperty(this[attrs.labelKey]).text;return 0===parseInt(labelKey.localeCompare(term),10)}).length){var choiceObj={};return choiceObj.newItem=!0,choiceObj[attrs.valueKey]=term,choiceObj[attrs.labelKey]=term,choiceObj}return null},initSelection:function(element,callback){var id,data=[],ids=element.val().split(",");$(ids).each(function(){id=this,$(scope.options).each(function(){0===parseInt(id.localeCompare(""+this[attrs.valueKey]),10)&&("true"===attrs.multiple?data.push(this):data=this)})}),callback(data)},formatResult:function(item){var labelKey=i18nDbService.getI18nProperty(item[attrs.labelKey]).text,htmlMarkup="<label>"+labelKey+"</label>";return item.newItem&&(htmlMarkup+=" <i>(New item)</i>"),htmlMarkup},formatSelection:function(item){return i18nDbService.getI18nProperty(item[attrs.labelKey]).text}};autoCompleteObj.select2(setup).select2("val",scope.model)}},!0)}}}]),COMPONENTS.directive("checkbox",["$rootScope","$timeout",function($rootScope,$timeout){"use strict";return{require:"ngModel",restrict:"A",replace:!0,template:'<div class="checkContainer"><input tabindex="{{tabindex}}" type="checkbox" id="checkbox{{$id}}"><label for="checkbox{{$id}}" ng-show="label" title="{{title}}" i18n-title><label i18n="{{label}}"></label></label></div>',scope:{ngModel:"=",ngClick:"&ngClick",label:"@",tabindex:"@",title:"@",blockUpdateModel:"@"},link:function(scope,element,attrs,ngModelCtrl){function updateState(newState){externalModelChange||("true"!==scope.blockUpdateModel&&(scope.ngModel=newState,ngModelCtrl.$setViewValue(scope.ngModel)),$rootScope.$$phase||scope.$apply(),scope.ngClick&&scope.ngClick())}var externalModelChange=!1;$timeout(function(){element.iCheck({checkboxClass:"check icheckbox_square-blue",increaseArea:"20%"}),scope.ngModel?element.iCheck("check"):element.iCheck("uncheck")},0),scope.$watch("ngModel",function(newVal){externalModelChange=!0,element.iCheck(newVal?"check":"uncheck"),setTimeout(function(){externalModelChange=!1},0)}),element.on("ifChecked",function(){updateState(!0)}),element.on("ifUnchecked",function(){updateState(!1)})}}}]),COMPONENTS.directive("colorPicker",["styleService","i18nService",function(styleService,i18nService){"use strict";return{require:"ngModel",restrict:"A",replace:!0,template:'<div class="colorPicker"><input type="text" placeholder="{{getI18nPlaceholder()}}"/><div class="transparentToggle" checkbox ng-model="isTransparent" label="colorPicker.transparent" ng-click="toggleTransparent()" /></div>',scope:{model:"=ngModel",placeholder:"@",onChange:"="},link:function(scope,element,attrs,ngModelCtrl){function setTransparentColor(){scope.isTransparent=!0,scope.model="transparent",inputElm.attr("readonly","readonly")}function removeTransparentColor(){scope.isTransparent=!1,scope.model="",inputElm.removeAttr("readonly")}var rgbObj=null,inputElm=$(' > input[type="text"]',element);scope.model&&("transparent"===scope.model&&(scope.isTransparent=!0),rgbObj=styleService.rgbStrToRgbObj(scope.model),rgbObj&&(scope.model=styleService.rgbObjToHexStr(rgbObj))),inputElm.minicolors({letterCase:"uppercase",animationSpeed:0,showSpeed:0,hideSpeed:0,show:function(){removeTransparentColor(),$(this).focus()},changeDelay:10,change:function(hex){scope.model||(scope.model=""),hex.toLowerCase()!==scope.model.toLowerCase()&&ngModelCtrl.$setViewValue(scope.model),scope.model=hex,scope.$apply()}}),scope.$watch("model",function(newVal){if(scope.isTransparent){try{inputElm.minicolors("value","")}catch(ex){}setTransparentColor()}else try{inputElm.minicolors("value",newVal)}catch(ex){}}),inputElm.blur(function(){scope.onChange&&scope.onChange()}),scope.getI18nPlaceholder=function(){return i18nService(scope.placeholder)},scope.toggleTransparent=function(){scope.isTransparent?setTransparentColor():removeTransparentColor(),scope.$apply()}}}}]),function(){"use strict";COMPONENTS.directive("contentEditable",["$rootScope","textSelectionService","domService","roleService","sessionService","editBoxUtilsService","styleService",function($rootScope,textSelectionService,domService,roleService,sessionService,editBoxUtilsService,styleService){return{priority:-1,require:"ngModel",scope:{contentEditable:"=",content:"=ngModel",customPanels:"=panels",type:"=",options:"=",onBlur:"=",placeholder:"@",uxChange:"=uxChange"},replace:!0,templateUrl:"/client/html/input/contentEditable.html",link:function(scope,element,attrs,ctrl){function updateValue(){"<br>"===contentEditableObj.html()&&contentEditableObj.html(""),scope.content=contentEditableObj.html(),handlePlaceholder(),ctrl.$setViewValue(scope.content),scope.uxChange&&scope.uxChange()}function forceTextSelection(){textSelectionService.setFakeSelection(),textSelectionService.saveSelection()}function handlePlaceholder(){scope.showPlaceholder=void 0===scope.content||""===scope.content}var contentEditableObj=$(" > [contenteditable]",element),userSession=sessionService.getUserSession();scope.isAdmin=function(){return roleService.hasAdminRole(userSession)},scope.onKeyup=function(){updateValue()},scope.isEditable=function(){var hasRights=void 0!==scope.contentEditable?scope.contentEditable:scope.isAdmin();return hasRights&&!contentEditableObj.attr("readonly")&&!contentEditableObj.attr("disabled")},scope.$watch("content",function(){contentEditableObj.is(":focus")||contentEditableObj.html(scope.content||""),handlePlaceholder()}),scope.showEditBox=function(){if(scope.isAdmin()&&textSelectionService.isSelection()){var selectedTextDomObj=textSelectionService.getSelectedTextDomObj(),defaultPanels=[{title:"Content",type:"richContent"}];scope.model=styleService.getComputedStyleInRange(contentEditableObj,selectedTextDomObj),forceTextSelection(),scope.panels=scope.customPanels?scope.customPanels:defaultPanels,scope.onSave=function(){textSelectionService.removeSelection(),updateValue(),setTimeout(function(){contentEditableObj.blur()},0)},scope.onCancel=function(){textSelectionService.removeSelection(),contentEditableObj.blur()},scope.onChange=function(styles){textSelectionService.restoreSelection(),textSelectionService.setStylesToSelection(styles),updateValue()},editBoxUtilsService.showEditBox(scope,contentEditableObj,selectedTextDomObj)}},contentEditableObj.blur(function(){editBoxUtilsService.isEditBoxVisible()||scope.onBlur&&scope.onBlur()}),scope.options&&scope.options.allowMultiLine===!1&&contentEditableObj.keypress(function(e){return 13!==e.which})}}}])}(),function(){COMPONENTS.directive("fileUploader",["mediaService","arrayService","stdService",function(mediaService,arrayService,stdService){"use strict";return{restrict:"E",replace:!0,templateUrl:"/client/html/input/fileUploader.html",scope:{model:"=ngModel",endpoint:"@",onUpload:"=",defaultMediaUrl:"=",multiple:"@",preview:"@"},link:function(scope,element){scope.getDownloadUrl=function(file){return arrayService.isArray(file)&&(file=file[0]),file&&file._id?mediaService.getDownloadUrl(file):scope.defaultMediaUrl?scope.defaultMediaUrl:null},scope.getFileTitle=function(file){return mediaService.getMediaHtmlDetails(file)},scope.selectFile=function(){$('input[type="file"]',element).click()},scope.submit=function(){return element.ajaxSubmit({error:function(xhr){stdService.error("Error uploading file",xhr)},success:function(uploadedFile){scope.model&&(scope.model=uploadedFile[0]),scope.$apply(),scope.onUpload&&scope.onUpload(uploadedFile),scope.$apply()}}),!1}}}}])}(),function(){"use strict";COMPONENTS.directive("password",[function(){return{restrict:"A",require:"ngModel",replace:!0,templateUrl:"/client/html/input/password.html",scope:{model:"=ngModel"},link:function(scope){scope.togglePassword=function(){scope.changePasswordActive=scope.changePasswordActive!==!0,scope.hangePasswordActive||(scope.model=null)}}}}])}(),COMPONENTS.directive("radio",["$rootScope","$timeout",function($rootScope,$timeout){"use strict";return{require:"ngModel",restrict:"A",replace:!0,template:'<div class="checkContainer"><input tabindex="{{tabindex}}" type="radio" id="radio{{$id}}" name="{{name}}"><label for="radio{{$id}}" ng-show="label" title="{{title}}" i18n-title><label i18n="{{label}}"></label></label></div>',scope:{ngModel:"=",name:"@",label:"@",tabindex:"@",title:"@"},link:function(scope,element,attrs,ngModelCtrl){function updateState(newState){newState&&!externalModelChange&&("true"!==scope.blockUpdateModel&&(scope.ngModel=newState,ngModelCtrl.$setViewValue(scope.ngModel)),scope.ngClick&&scope.ngClick(),$rootScope.$$phase||scope.$apply())}var externalModelChange=!1;$timeout(function(){element.iCheck({radioClass:"check iradio_square-blue",increaseArea:"20%"})},0),scope.ngModel===attrs.value&&$(" > input",element).attr("checked",!0),element.on("ifChecked",function(){updateState(attrs.value)})}}}]),COMPONENTS.directive("rating",["crudService","constantsService",function(crudService,constantsService){"use strict";return{restrict:"A",replace:!0,scope:{rating:"=",targetId:"=",targetCollection:"@",starSize:"@height"},templateUrl:"/client/html/input/rating.html",link:function(scope){function initRating(){scope.normalizedRating=[],scope.rateOnHover=0,normalizeRating()}function normalizeRating(){var i,maxRate=5;for(i=0;maxRate>i;i+=1)scope.normalizedRating[i]=scope.rating>i&&scope.rating>=i+1?"full":scope.rating>i?"half":"none"}scope.$watch("rating",function(){initRating()}),scope.$watch("targetId",function(){initRating()}),scope.hoverRate=function(rating){scope.rateOnHover=rating},scope.clearHoverRate=function(){scope.rateOnHover=0},scope.getStarStyleClass=function(rating,desc){var hover=rating<=scope.rateOnHover?"hoverState":"";return desc+"-rated "+hover},scope.rate=function(rating){var data={rating:rating,target:{id:scope.targetId,collection:scope.targetCollection}};crudService.rate(constantsService.collections.ratings,data,function(avgRating){scope.rating=avgRating.avgRating,normalizeRating()})},scope.getStarSize=function(){var defaultSize=24;return{width:scope.starSize||defaultSize,height:scope.starSize||defaultSize}}}}}]),COMPONENTS.directive("contentList",["constantsService",function(constantsService){"use strict";return{restrict:"E",replace:!0,templateUrl:"/client/html/list/contentList.html",scope:{_id:"=id",config:"=",refreshList:"="},link:function(scope){scope.items=[],scope.collection=constantsService.collections.content,scope.searchTargets=["title","summary","content"],scope.onSelectPanels=[{title:"Edit content",type:"editContent"}]}}}]),function(Math,Number,COMPONENTS){"use strict";COMPONENTS.directive("list",["$rootScope","$location","portalService","rowService","crudService","editBoxUtilsService","domService","arrayService","roleService","sessionService","stringService","dbService","i18nService",function($rootScope,$location,portalService,rowService,crudService,editBoxUtilsService,domService,arrayService,roleService,sessionService,stringService,dbService,i18nService){return{restrict:"A",replace:!0,transclude:!0,templateUrl:"/client/html/list/list.html",require:"?ngModel, config",scope:{_id:"=id",collection:"=",items:"=list",config:"=",onSelect:"=",onSelectPanels:"=",projection:"=",searchTargets:"=",refreshList:"=",transcludedData:"="},link:function(scope,element){function showEditBox(item){var targetObj=$("#"+item._id+" > *:first-child",element);hideEditBox(),scope.panels=scope.onSelectPanels,scope.model=item,scope.onClose=function(){scope.unselect(item)},editBoxUtilsService.showEditBox(scope,targetObj,targetObj)}function hideEditBox(){editBoxUtilsService.hideEditBox(null)}function allowIfHasAdminRole(action){return isAdmin()?action:!1}function isAdmin(){return roleService.hasAdminRole(userSession)}function setCurrentPage(){(scope.currentPage+1)*scope.getDefaultedValue("pageSize")>scope.totalSize&&(scope.currentPage=Math.floor(scope.totalSize/scope.getDefaultedValue("pageSize")))}function deleteFromSeletedIds(id){var itemSelectedPos=getItemSelectedPos(id);void 0!==itemSelectedPos&&arrayService.delete(scope.selectedIds,itemSelectedPos)}function getItemSelectedPos(itemId){var i,itemSelectedPos=null;if(scope.selectedIds)for(i=0;i<scope.selectedIds.length;i+=1)if(scope.selectedIds[i]===itemId){itemSelectedPos=i;break}return itemSelectedPos}function getFilterOptions(){var filterOptions=[],currentLanguage=i18nService.getCurrentLanguage(),inexactSelector=dbService.getInexactSelector(scope.searchText);return scope.searchTargets.forEach(function(searchTarget){var i18nSearchTarget,filterOption={},i18nFilterOption={};filterOption[searchTarget]=inexactSelector,filterOptions.push(filterOption),i18nSearchTarget=searchTarget+"."+currentLanguage+".text",i18nFilterOption[i18nSearchTarget]=inexactSelector,filterOptions.push(i18nFilterOption)}),filterOptions}function getTagOptions(){var tagOptions=[];return scope.config.tags&&scope.config.tags.forEach(function(tag){tagOptions[tagOptions.length]={tag:tag}}),tagOptions}function setDetailId(detailId){scope.detailId=detailId}function handleDefaultSelectionMechanism(item,editOnSelect,$event){item.isSelected?$event&&editBoxUtilsService.isEditBoxClicked($event)||(scope.unselect(item),scope.isEditable()&&hideEditBox()):(scope.select(item),scope.isEditable()&&editOnSelect&&showEditBox(item))}function handleCustomSelectionMechanism(item,$index){scope.onSelect(item,$index,scope.isSelectable())}function handleNavigationMechanism(item){setDetailId(item._id),$location.search("detailId",item._id)}var lastSelectedItem,userSession=sessionService.getUserSession(),defaultOptions={pageSize:10,skip:0,pageActionPos:2,searchable:!0,sort:{field:"create.date",order:"1"}};scope.search=function(){scope.loadList()},scope.isPageActionsTop=function(){var pageActionPos=Number(scope.getDefaultedValue("pageActionPos"));return 0===pageActionPos||2===pageActionPos},scope.isPageActionsBottom=function(){var pageActionPos=Number(scope.getDefaultedValue("pageActionPos"));return 1===pageActionPos||2===pageActionPos},scope.select=function(item){scope.isMultiSelectable()?(scope.selectedIds||(scope.selectedIds=[]),item.isSelected||scope.selectedIds.push(item._id)):scope.isSingleSelectable()&&(scope.selectedIds=item._id,lastSelectedItem&&(lastSelectedItem.isSelected=!1)),lastSelectedItem=item,item.isSelected=!0,$rootScope.$$phase||scope.$apply()},scope.unselect=function(item){scope.isMultiSelectable()?item.isSelected&&deleteFromSeletedIds(item._id):scope.isSingleSelectable()&&(scope.selectedIds=null),item.isSelected=!1,$rootScope.$$phase||scope.$apply()},scope.selectItem=function(item,$index,$event,editOnSelect){scope.isSelectable()?handleDefaultSelectionMechanism(item,editOnSelect,$event):handleNavigationMechanism(item),scope.onSelect&&handleCustomSelectionMechanism(item,$index)},scope.getWrapperClass=function(){return scope.isSelectable()?"selectable":""},scope.getItemStyleClasses=function(item){var maxColSize=rowService.getMaxSlots(),columnWidth=scope.config.columns?Math.floor(maxColSize/scope.config.columns):maxColSize,viewMode=scope.detailId?"detailView":"listView";return"large-"+columnWidth+" "+viewMode+" "+(item.isSelected?"active":"")},scope.getDefaultedValue=function(scopeProp){return stringService.isEmpty(scope.config[scopeProp])?defaultOptions[scopeProp]:scope.config[scopeProp]},scope.delete=function(id){crudService.delete(scope.collection,id,null),deleteFromSeletedIds(id),scope.loadList()},scope.deleteDetailId=function(){$location.search("detailId",null)},scope.loadList=function(){var filter={q:{$and:[{$or:getFilterOptions()},{$or:getTagOptions()}]},currentPage:scope.currentPage,pageSize:scope.getDefaultedValue("pageSize"),skip:scope.getDefaultedValue("skip"),sort:scope.getDefaultedValue("sort"),projection:scope.projection};crudService.get(scope.collection,null,filter,function(list){scope.totalSize=list.totalSize,scope.items=list.results})},scope.isSearchable=function(){return scope.getDefaultedValue("searchable")},scope.isSelectable=function(){return scope.isSingleSelectable()||scope.isMultiSelectable()},scope.isSingleSelectable=function(){return allowIfHasAdminRole(scope.config.selectable)},scope.isMultiSelectable=function(){return allowIfHasAdminRole(scope.config.multiSelectable)},scope.isEditable=function(){return allowIfHasAdminRole(scope.config.editable)},scope.isDeletable=function(){return allowIfHasAdminRole(scope.config.deletable)},scope.refreshList&&(scope.refreshList=function(){setCurrentPage(),scope.loadList()}),scope.$watch("collection",function(){scope.loadList()}),scope.searchText="",scope.currentPage=0,$rootScope.$on(scope.collection+"Changed",function(){scope.loadList()}),setDetailId($location.search().detailId),scope.$on("$routeUpdate",function(){setDetailId($location.search().detailId)})}}}])}(window.Math,window.Number,window.COMPONENTS),function(Number){"use strict";COMPONENTS.directive("listActions",["arrayService",function(arrayService){return{restrict:"A",replace:!0,templateUrl:"/client/html/utils/listActions.html",link:function(scope){function selectAll(){scope.items.forEach(function(item){scope.select(item)})}function unselectAll(){scope.items.forEach(function(item){scope.unselect(item)})}function deleteSelected(){var selectedIds=arrayService.copy(scope.selectedIds);selectedIds.forEach(function(id){scope.delete(id)})}scope.getPrevPage=function(){scope.currentPage-=1,scope.loadList()},scope.getNextPage=function(){scope.currentPage+=1,scope.loadList()},scope.showPrevPageLink=function(){return scope.getDefaultedValue("pageSize")&&scope.currentPage>0},scope.showNextPageLink=function(){return(scope.currentPage+1)*Number(scope.getDefaultedValue("pageSize"))<scope.totalSize},scope.toggleSelectAll=function(){scope.selectedIds&&scope.items.length===scope.selectedIds.length?unselectAll():selectAll()},scope.deleteSelected=function(){deleteSelected()}}}}])}(window.Number),COMPONENTS.directive("listEdit",["rowService","tagService",function(rowService,tagService){"use strict";return{restrict:"A",replace:!1,templateUrl:"/client/html/utils/listEdit.html",link:function(scope){scope.availableTags=tagService.getTags(),scope.sortTypes={field:[{id:"create.date",text:"Create date"},{id:"update.date",text:"Update date"},{id:"create.author",text:"Create author"},{id:"update.author",text:"Update author"}],order:[{id:"1",text:"Asc"},{id:"-1",text:"Desc"}]},scope.model.sort||(scope.model.sort={field:scope.sortTypes.field[0].id,order:scope.sortTypes.order[1].id}),scope.columnOptions=[];
for(var index=0;index<rowService.getMaxSlots();index+=1)scope.columnOptions.push({value:index+1,text:index+1});scope.model.columns||(scope.model.columns=1)}}}]),function(){"use strict";COMPONENTS.directive("listExpandedView",[function(){return{restrict:"A",replace:!0,transclude:!0,template:'<div ng-show="detailId"><div ng-transclude></div></div>'}}])}(),COMPONENTS.directive("mediaList",["$rootScope","mediaService","constantsService",function($rootScope,mediaService,constantsService){"use strict";return{restrict:"E",replace:!0,scope:{config:"=",refreshList:"=",onSelect:"="},templateUrl:"/client/html/list/mediaList.html",link:function(scope){scope.items=[],scope.collection=constantsService.collections.media,scope.projection={data:0},scope.searchTargets=["name"],scope.onSelectPanels=[{title:"Edit media",type:"editMedia"}],scope.$watch("config",function(newConfig){newConfig&&!newConfig.columns&&(newConfig.columns=4)}),scope.onUpload=function(){scope.refreshList&&(scope.refreshList(),$rootScope.$broadcast("mediaChanged","create"))},scope.onSelectMedia=function(item,index,selectable){selectable||(scope.popupMediaIndex=index),scope.onSelect&&scope.onSelect(item)},scope.transcludedData={},scope.transcludedData.getDownloadUrl=function(media){return mediaService.getDownloadUrl(media)},scope.transcludedData.getMediaHtmlDetails=function(media){return mediaService.getMediaHtmlDetails(media)},scope.transcludedData.showMediaPopup=function(index){scope.popupMediaIndex=index},scope.transcludedData.getMediaTitle=function(media){return mediaService.getMediaHtmlDetails(media)}}}}]),function(COMPONENTS){"use strict";COMPONENTS.directive("nestedItems",["$compile",function($compile){return{restrict:"E",replace:!0,transclude:!0,terminal:!0,scope:{items:"=",selectedItem:"=",onSelect:"&",onAdd:"&",onDelete:"&",sortableOptions:"="},link:function(scope,element){function emitFn(fn,item){scope[fn]&&scope[fn]({$item:item})}scope.selectItem=function(item){emitFn("onSelect",item)},scope.addItem=function(item){emitFn("onAdd",item)},scope.deleteItem=function(item){emitFn("onDelete",item)},scope.emitSelect=function(item){emitFn("onSelect",item)},scope.emitAdd=function(item){emitFn("onAdd",item)},scope.emitDelete=function(item){emitFn("onDelete",item)},scope.toggleSubItems=function(item){item.areSubItemsHidden=item.areSubItemsHidden!==!0},scope.getToggleSubItemsIcon=function(item){return item.areSubItemsHidden!==!0?"downIcon":"rightIcon"},scope.$watch("sortableOptions",function(newVal){if(newVal){var template='<ul ui-sortable="sortableOptions" ng-model="items" class="items"><li ng-repeat="item in items" class="item" ng-class="{hasSubItems:item.items.length}"ng-show="!item.deleted"><div class="box" ng-class="{selected:item._id == selectedItem._id, collapsed:item.areSubItemsHidden}"><div class="sortingBox"></div><button class="toggleSubItems small" ng-click="toggleSubItems(item)" ng-show="item.items.length" ng-class="getToggleSubItemsIcon(item)"></button><div ng-click="selectItem(item)"><label i18n-db="item.text"></label></div><div class="actions"><button class="addIcon" ng-click="addItem(item)"></button><button class="removeIcon" ng-click="deleteItem(item)"></button></div></div><div class="subItemsContainer" ng-class="{hasSubItems:item.items.length}" ng-show="!item.areSubItemsHidden"><nested-items items="item.items" on-select="emitSelect($item)" on-add="emitAdd($item)" on-delete="emitDelete($item)" selected-item="selectedItem" sortable-options="sortableOptions"></nested-items></div></li></ul>';element.append(template),$compile(element.contents())(scope)}})}}}])}(window.COMPONENTS),function(COMPONENTS){"use strict";COMPONENTS.directive("nestedItemsWrapper",["globalMsgService","i18nService","timerService","$timeout",function(globalMsgService,i18nService,timerService,$timeout){return{restrict:"E",replace:!0,template:'<div><nested-items items="items" sortable-options="sortableOptions" selected-item="selectedItem" on-select="onSelectItem($item)" on-add="onAddItem($item)" on-delete="onDeleteItem($item)"></nested-items><button class="addIcon floatRight" ng-click="addRootItem()"></button></div>',scope:{items:"=",selectedItem:"=",onSelect:"&",onAdd:"&"},link:function(scope){function addItem(siblingItems){var newItem={_id:timerService.getRandomNumber(),text:i18nService("editPages.newPage"),items:[],position:scope.items.length,added:!0};siblingItems.push(newItem),scope.onSelectItem(newItem),scope.onAdd&&scope.onAdd({$item:newItem})}function deleteItem(item){item.deleted=!0,item.items&&item.items.forEach(function(item){deleteItem(item)})}function undeleteItem(item){item.deleted=!1,item.items&&item.items.forEach(function(item){undeleteItem(item)})}function getNonDeletedItems(items){var nonDeletedItems=[];return items.forEach(function(item){item.deleted||(nonDeletedItems.push(item),getNonDeletedItems(item.items).forEach(function(item){nonDeletedItems.push(item)}))}),nonDeletedItems}function onUpdate(){$timeout(function(){markAllItemsAsUpdated()},0)}function markAllItemsAsUpdated(items,accumulativeIndex){items?accumulativeIndex+=1:(items=scope.items,accumulativeIndex=0),items.forEach(function(item,index){item.updated=!0,item.position=index+accumulativeIndex,markAllItemsAsUpdated(item.items,item.position)})}scope.sortableOptions={items:"li",connectWith:"[ui-sortable]",placeholder:"sortingPlaceholder",forceHelperSize:!0,forcePlaceholderSize:!0,tolerance:"pointer",cursorAt:{top:0,left:0},handle:".sortingBox",update:onUpdate},scope.onSelectItem=function(item){scope.onSelect&&scope.onSelect({$item:item})},scope.addRootItem=function(){addItem(scope.items)},scope.onAddItem=function(item){addItem(item.items)},scope.onDeleteItem=function(item){var canBeDeleted,nonDeletedItemFound=!1;deleteItem(item),canBeDeleted=getNonDeletedItems(scope.items).length>0,canBeDeleted?item._id===scope.selectedItem._id&&scope.items.forEach(function(item){item.deleted||nonDeletedItemFound||(scope.selectedItem=item,nonDeletedItemFound=!0)}):(undeleteItem(item),globalMsgService.show(i18nService("editPages.cannotDeletePage")))}}}}])}(window.COMPONENTS),function(){"use strict";COMPONENTS.directive("nestedPagesWrapper",["pageService","rowService","$timeout",function(pageService,rowService,$timeout){return{restrict:"E",replace:!0,template:'<div><nested-items-wrapper items="items" on-select="onSelect($item)" selected-item="selectedItem"on-add="onAddPage($item)"></nested-items-wrapper></div>',scope:{pages:"=",items:"=",selectedItem:"=",onAdd:"&"},link:function(scope){function getParentItem(parentId,parentItem){var matchedItem=null,items=parentItem?parentItem.items:scope.items;return items.forEach(function(candidateParentItem){candidateParentItem._id===parentId?matchedItem=candidateParentItem:matchedItem||(matchedItem=getParentItem(parentId,candidateParentItem))}),matchedItem}function normalizeItems(pages){scope.pages=pages,scope.items=[],scope.pages.forEach(function(page){if(page.items=[],page.parentPageId){var parentItem=getParentItem(page.parentPageId);parentItem.items.push(page)}else scope.items.push(page)}),selectFirstPage()}function selectFirstPage(){$timeout(function(){scope.selectedItem=scope.items[0]})}var pages;scope.selectedItem={},scope.onSelect=function(page){scope.selectedItem=page},scope.onAddPage=function(page){page.description="",page.rows=[rowService.getEmptyRow()],scope.onAdd&&scope.onAdd({$page:page})},pages=pageService.getPages(),normalizeItems(pages)}}}])}(),COMPONENTS.directive("tagList",["constantsService",function(constantsService){"use strict";return{restrict:"E",replace:!0,templateUrl:"/client/html/list/tagList.html",scope:{config:"=",refreshList:"="},link:function(scope){scope.items=[],scope.collection=constantsService.collections.tags,scope.searchTargets=["text"],scope.onSelectPanels=[{title:"Edit tag",type:"editTag"}]}}}]),COMPONENTS.directive("userList",["mediaService","constantsService",function(mediaService,constantsService){"use strict";return{restrict:"E",replace:!0,templateUrl:"/client/html/list/userList.html",scope:{config:"=",refreshList:"="},link:function(scope){scope.items=[],scope.collection=constantsService.collections.users,scope.projection={password:0},scope.searchTargets=["fullName","email"],scope.onSelectPanels=[{title:"Edit users",type:"editUser"}],scope.transcludedData={},scope.transcludedData.getUserAvatarUrl=function(item){return item.media?mediaService.getDownloadUrl(item.media):mediaService.getDefaultAvatarUrl()}}}}]),function(window,Number){"use strict";COMPONENTS.directive("mediaPopup",["mediaService","domService","stringService","keyboardService",function(mediaService,domService,stringService,keyboardService){return{restrict:"E",replace:!0,templateUrl:"/client/html/media/mediaPopup.html",scope:{mediaIndex:"=",mediaList:"="},link:function(scope,element){var imgObj=$("img",element),headerObj=$(".header",element),imgWrapper=$(".imgWrapper",element),directiveId="mediaPopup";imgObj.bind("load",function(){function registerKeyboardEvents(){keyboardService.register("left",directiveId,function(){scope.getPrevMedia(),scope.$apply()}),keyboardService.register("right",directiveId,function(){scope.getNextMedia(),scope.$apply()}),keyboardService.register("esc",directiveId,function(){scope.closePopup(),scope.$apply()})}scope.showPopup=!0,scope.isloadingImage=!0,scope.$apply(),registerKeyboardEvents()}),scope.getDownloadUrl=function(){return scope.isloadingImage=!1,stringService.isEmpty(scope.mediaIndex)?null:mediaService.getDownloadUrl(scope.mediaList[scope.mediaIndex])},scope.getMediaHtmlDetails=function(){return stringService.isEmpty(scope.mediaIndex)?null:mediaService.getMediaHtmlDetails(scope.mediaList[scope.mediaIndex])},scope.setCenterPosition=function(){if(scope.showPopup){var imgNormalizedWidth,imgNormalizedHeight,maxAllowedPercent=.7,maxAllowedWidth=Number($(window).width()*maxAllowedPercent),maxAllowedHeight=Number($(window).height()*maxAllowedPercent),imgOriginalWidth=scope.mediaList[scope.mediaIndex].width,imgOriginalHeight=scope.mediaList[scope.mediaIndex].height,aspectRatio=imgOriginalWidth/imgOriginalHeight,imgWrapperPadding=domService.getObjPadding(imgWrapper);return maxAllowedWidth>imgOriginalWidth&&maxAllowedHeight>imgOriginalHeight?(imgNormalizedHeight=scope.mediaList[scope.mediaIndex].height,imgNormalizedWidth=scope.mediaList[scope.mediaIndex].width):imgOriginalHeight>=imgOriginalWidth?(imgNormalizedHeight=maxAllowedHeight,imgNormalizedWidth=imgNormalizedHeight*aspectRatio):(imgNormalizedWidth=maxAllowedWidth,imgNormalizedHeight=imgNormalizedWidth/aspectRatio),{width:imgNormalizedWidth,height:imgNormalizedHeight+headerObj.outerHeight(),marginTop:-(imgNormalizedHeight/2)-(imgWrapperPadding.top+imgWrapperPadding.bottom),marginLeft:-(imgNormalizedWidth/2),visibility:scope.showPopup?"visible":"hidden"}}return null},scope.setNavigationActionsPosition=function(){if(scope.showPopup){var popupPadding=domService.getObjPadding(imgWrapper);return{marginTop:headerObj.outerHeight()+popupPadding.top,height:imgObj.height()}}return null},scope.getPrevMedia=function(){scope.mediaIndex>0&&(scope.mediaIndex-=1)},scope.getNextMedia=function(){scope.mediaIndex<scope.mediaList.length-1&&(scope.mediaIndex+=1)},scope.closePopup=function(){function unregisterKeyboardEvents(){keyboardService.unregister("left",directiveId),keyboardService.unregister("right",directiveId),keyboardService.unregister("esc",directiveId)}scope.showPopup=!1,scope.mediaIndex=null,unregisterKeyboardEvents()},scope.getImgWrapperClass=function(){return scope.isloadingImage?"loading":""}}}}])}(window,window.Number),function(){"use strict";COMPONENTS.directive("resizableApp",["resizableAppService",function(resizableAppService){return{restrict:"A",replace:!1,link:function(scope,element,attrs){function enableResizableApp(){element.resizable({handles:"e, w",start:function(event){resizableAppService.start($(this),event)},resize:function(){resizableAppService.resize($(this))}})}function disableResizableApp(){element.resizable("destroy")}var hasBeenInitialized=!1;attrs.$observe("resizableApp",function(newVal){"true"===newVal?(hasBeenInitialized=!0,enableResizableApp()):hasBeenInitialized&&disableResizableApp()})}}}])}(),function(){"use strict";COMPONENTS.directive("sortableAddApp",["keyboardService","$timeout",function(keyboardService,$timeout){return{restrict:"A",replace:!1,link:function(scope,element){function start(ui){$(ui.helper).css({width:element.outerWidth(),height:element.outerHeight()}),registerKeyboardEvents()}function stop(){unregisterKeyboardEvents()}function registerKeyboardEvents(){keyboardService.register("esc","sortableAddApp",function(){element.trigger("mouseup")})}function unregisterKeyboardEvents(){keyboardService.unregister("esc","sortableAddApp")}$timeout(function(){element.draggable({helper:"clone",connectToSortable:"[sortable-app]",forceHelperSize:!0,tolerance:"pointer",cursorAt:{top:0,left:0},start:function(event,ui){start(ui)},stop:function(){stop()}})},0)}}}])}(),function(){"use strict";COMPONENTS.directive("sortableApp",["pageService","sortableAppService",function(pageService,sortableAppService){return{restrict:"A",replace:!1,link:function(scope,element,attrs){function instantiateSortableApp(){scope.sortableOptions={items:".app",cancel:".content > *",connectWith:"[sortable-app]",placeholder:"sortingPlaceholder",tolerance:"pointer",cursorAt:{top:0,left:0},start:function(event,ui){sortableAppService.start(ui)},update:function(event,ui){sortableAppService.update(ui)},stop:function(){sortableAppService.stop()}}}var sortableWrapElm=element.closest("[sortable-app]");scope.sortableOptions={},instantiateSortableApp(),attrs.$observe("sortableApp",function(newVal){"true"!==newVal?sortableWrapElm.sortable("disable"):sortableWrapElm.sortable("enable")})}}}])}(),function(document){"use strict";COMPONENTS.directive("boxSortable",["keyboardService",function(keyboardService){return{restrict:"A",transclude:!0,template:'<ul class="sortable" ng-transclude></ul>',scope:{onChange:"=uxChange",handle:"@",connectWith:"@"},replace:!0,link:function(scope,element,attrs){var updateFn=function(){scope.onChange&&scope.onChange()},sortingElms=attrs.connectWith?$(attrs.connectWith):element;element.sortable({placeholder:"sortingPlaceholder",forceHelperSize:!0,forcePlaceholderSize:!0,connectWith:attrs.connectWith,tolerance:"pointer",handle:attrs.handle||"",cursorAt:{top:0,left:0},start:function(){sortingElms.addClass("sorting"),keyboardService.register("esc","boxSortable",function(){element.sortable("option","update",function(){return!1}),$(document).trigger("mouseup"),element.sortable("option","update",function(){updateFn()})})},stop:function(){sortingElms.removeClass("sorting"),keyboardService.unregister("esc","boxSortable")},update:updateFn}),element.disableSelection()}}}])}(window.document),function(){COMPONENTS.directive("multipleFiles",[function(){"use strict";return{restrict:"A",link:function(scope,element,attrs){attrs.$observe("multipleFiles",function(newVal){"true"===newVal?element.attr("multiple",""):element.removeAttr("multiple")})}}}])}(),function(){"use strict";function capitalize(string){return string.charAt(0).toUpperCase()+string.slice(1)}var forEach=angular.forEach,events=["change","keyup"];forEach(events,function(event){var directiveName="ux"+capitalize(event);COMPONENTS.directive(directiveName,["$parse",function($parse){return function(scope,elm,attrs){var fn=$parse(attrs[directiveName]);elm.bind(event,function(e){scope.$apply(function(){fn(scope,{$event:e})})})}}])})}(),function(){"use strict";COMPONENTS.directive("uxShow",["constantsService",function(constantsService){return{terminal:!0,transclude:"element",priority:100,restrict:"A",compile:function(tElement,tAttrs,transclude){return function(scope,iElement,iAttr){function showContent(){contentScope=scope.$new(),transclude(contentScope,function(clonedElm){iElement.after(clonedElm),setTimeout(function(){contentElm=iElement.next()},constantsService.keyboardInterval)})}function hideContent(){contentElm&&(contentElm.remove(),contentElm=null),contentScope&&(contentScope.$destroy(),contentScope=null)}var contentElm,contentScope;scope.$watch(iAttr.uxShow,function(expValue){expValue?showContent():hideContent()})}}}}])}(),COMPONENTS.directive("emailMandatory",["emailService","validationService",function(emailService,validationService){"use strict";return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var value=scope.$eval(attrs.ngModel),validationTitle="Please enter a valid e-mail",validationKey="emailMandatory",validationFn=function(viewValue){return!viewValue||""===viewValue||emailService.validateEmail(viewValue)};validationService.setupValidation(value,element,ctrl,validationTitle,null,validationKey,validationFn)}}}]),COMPONENTS.directive("mandatory",["validationService",function(validationService){"use strict";return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var value=scope.$eval(attrs.ngModel),validationTitle="This field is required",validationKey="mandatory",validationFn=function(viewValue){return viewValue&&""!==viewValue};validationService.setupValidation(value,element,ctrl,validationTitle,null,validationKey,validationFn)}}}]),COMPONENTS.directive("passwordMandatory",["$compile","validationService",function($compile,validationService){"use strict";return{require:"ngModel",link:function(scope,element,attrs,ctrl){var value=scope.$eval(attrs.ngModel),validationTitle="Password must meet the following requirements",validationKey="passwordMandatory",errorHtmlDetails='<ul><li ng-class="pwdHasLetter">At least <strong>one letter</strong></li><li ng-class="pwdHasNumber">At least <strong>one number</strong></li><li ng-class="pwdValidLength">At least <strong>8 characters long</strong></li></ul>',compiledErrorHtmlDetails=$compile(errorHtmlDetails)(scope),validationFn=function(viewValue){return viewValue?(scope.pwdValidLength=viewValue&&viewValue.length>=8?"valid":void 0,scope.pwdHasLetter=viewValue&&/[A-z]/.test(viewValue)?"valid":void 0,scope.pwdHasNumber=viewValue&&/\d/.test(viewValue)?"valid":void 0,scope.pwdValidLength&&scope.pwdHasLetter&&scope.pwdHasNumber):!0};validationService.setupValidation(value,element,ctrl,validationTitle,compiledErrorHtmlDetails,validationKey,validationFn)}}}]),function(){"use strict";COMPONENTS.factory("ajaxService",["$http","loadingService",function($http,loadingService){function ajax(options){var settings={url:options.url,method:options.method||"GET",data:options?options.data:{}};settings.data&&"GET"===settings.method&&(settings.url=settings.url+"?"+decodeURIComponent($.param(settings.data))),loadingService.start(),$http(settings).success(function(data){options.success&&options.success(data)}).error(function(data){options.error&&options.error(data)}),loadingService.done()}return{ajax:ajax}}])}(),function(){"use strict";COMPONENTS.factory("availableAppsService",["crudService","constantsService",function(crudService,constantsService){function loadAvailableApps(callback){var filter={sort:{field:"category",order:"-1"}};crudService.get(constantsService.collections.availableApps,null,filter,function(availableApps){setAvailableApps(availableApps.results),callback&&callback(getAvailableApps())})}function getAvailableApps(){return availableApps}function setAvailableApps(retrievedAvailableApps){var index=0;availableApps={index:{},model:[]},retrievedAvailableApps.forEach(function(retrievedAvailableApp){categorizeApp(retrievedAvailableApp),availableApps.index[retrievedAvailableApp.id]=index,availableApps.model.push(retrievedAvailableApp),index+=1})}function categorizeApp(availableApp){availableApp.category||(availableApp.category=constantsService.defaultCategory),categories[availableApp.category]||(categories[availableApp.category]=!0,availableApp.firstInCategory=!0)}var availableApps,categories=[];return{loadAvailableApps:loadAvailableApps,getAvailableApps:getAvailableApps}}])}(),function(){"use strict";COMPONENTS.factory("constantsService",[function(){return{appKey:"app",appsPath:"/client/apps",defaultCategory:"Others",collections:{portal:"portal",pages:"pages",availableApps:"availableApps",content:"content",media:"media",users:"users",roles:"roles",comments:"comments",ratings:"ratings",tags:"tags",languages:"languages"},roles:{guest:"guest",reader:"reader",creator:"creator",admin:"admin"},templates:{view:"view",edit:"edit",help:"help"},renderTypes:{dom:"dom",canvas:"canvas"},pageTypes:{apps:"apps",externalLink:"externalLink"},blurOpacity:.3,keyboardInterval:100}}])}(),function(){"use strict";COMPONENTS.factory("contentService",["crudService","constantsService",function(crudService,constantsService){function createContent(content,callback){var data;content&&(content.title||content.summary||content.content)?(data={title:content.title,summary:content.summary,content:content.content,tags:content.tags},crudService.create(constantsService.collections.content,data,function(newContent){callback&&callback(newContent)})):callback&&callback({})}function updateContent(content,callback){var data;content&&(content.title||content.summary||content.content)?(data={title:content.title,summary:content.summary,content:content.content,tags:content.tags},crudService.update(constantsService.collections.content,content._id,data,function(updatedContent){callback&&callback(updatedContent)})):callback&&callback({})}return{createContent:createContent,updateContent:updateContent}}])}(),function(COMPONENTS){"use strict";COMPONENTS.factory("crudService",["$rootScope","ajaxService","constantsService",function($rootScope,ajaxService,constantsService){function create(collection,data,callback,blockBroadcastEvent){ajaxService.ajax({url:"/rest/"+collection+"/create",data:data,method:"POST",success:function(newItem){blockBroadcastEvent||$rootScope.$broadcast(collection+"Changed","create"),callback&&callback(newItem)}})}function createUser(data,callback,blockBroadcastEvent){ajaxService.ajax({url:"/rest/"+constantsService.collections.users+"/createUser",data:data,method:"POST",success:function(newItem){blockBroadcastEvent||$rootScope.$broadcast(constantsService.collections.users+"Changed",newItem._id),callback&&callback(newItem)}})}function get(collection,id,data,callback){ajaxService.ajax({url:"/rest/"+collection+(id?"/"+id:""),data:data?data:{},method:"GET",success:function(retrievedItem){callback&&callback(retrievedItem)}})}function update(collection,id,data,callback,blockBroadcastEvent){ajaxService.ajax({url:"/rest/"+collection+"/"+id+"/update",data:data,method:"PUT",success:function(updatedItem){blockBroadcastEvent||$rootScope.$broadcast(collection+"Changed",id),callback&&callback(updatedItem)}})}function updateUser(id,data,callback,blockBroadcastEvent){ajaxService.ajax({url:"/rest/"+constantsService.collections.users+"/"+id+"/updateUser",data:data,method:"PUT",success:function(updatedUser){blockBroadcastEvent||$rootScope.$broadcast(constantsService.collections.users+"Changed",id),callback&&callback(updatedUser)}})}function remove(collection,id,callback,blockBroadcastEvent){ajaxService.ajax({url:"/rest/"+collection+"/"+id+"/delete",method:"DELETE",success:function(){blockBroadcastEvent||$rootScope.$broadcast(collection+"Changed",id),callback&&callback()}})}function getStats(collection,data,callback){ajaxService.ajax({url:"/rest/"+collection+"/getStats",data:data?data:{},method:"GET",success:function(newItem){callback&&callback(newItem)}})}function rate(collection,data,callback){ajaxService.ajax({url:"/rest/"+collection+"/rate",data:data,method:"POST",success:function(newItem){callback&&callback(newItem)}})}function undeployApp(id,data,callback,blockBroadcastEvent){ajaxService.ajax({url:"/rest/"+constantsService.collections.availableApps+"/"+id+"/undeploy",data:data,method:"POST",success:function(){blockBroadcastEvent||$rootScope.$broadcast(constantsService.collections.availableApps+"Undeployed",data.id),callback&&callback({})}})}return{create:create,createUser:createUser,get:get,update:update,updateUser:updateUser,"delete":remove,getStats:getStats,rate:rate,undeployApp:undeployApp}}])}(window.COMPONENTS),function(COMPONENTS){"use strict";COMPONENTS.factory("dbService",[function(){function getInsensitiveSelector(selector,exact){var regexSelector=exact?"^"+selector+"$":selector;return{$regex:regexSelector,$options:"i"}}function getInexactSelector(selector){return{$regex:"^.*"+selector+".*",$options:"i"}}return{getInsensitiveSelector:getInsensitiveSelector,getInexactSelector:getInexactSelector}}])}(window.COMPONENTS),function(COMPONENTS){"use strict";COMPONENTS.factory("pageService",["$rootScope","crudService","rowService","constantsService",function($rootScope,crudService,rowService,constantsService){function loadPages(callback){var params={sort:{field:"position",order:"1"}};crudService.get(constantsService.collections.pages,null,params,function(returnedPages){pages=returnedPages.results,callback&&callback(getPages())})}function getPages(){return pages}function getPage(url){var matchedPage=null;return pages.forEach(function(page){page.url.toLowerCase()!==url.toLowerCase()||matchedPage||(matchedPage=page)}),matchedPage}function createPage(data,callback){crudService.create(constantsService.collections.pages,data,function(){loadPages(function(){$rootScope.$broadcast(constantsService.collections.pages+"Changed","create"),callback&&callback()})},!0)}function updatePage(pageId,data,callback){crudService.update(constantsService.collections.pages,pageId,data,function(data){loadPages(function(){$rootScope.$broadcast(constantsService.collections.pages+"Changed",pageId),callback&&callback(data)})},!0)}function updateCurrentPage(callback){var currentPage=getCurrentPage();updatePage(currentPage._id,currentPage,function(data){callback&&callback(data)})}function deletePage(pageId,callback){crudService.delete(constantsService.collections.pages,pageId,function(){loadPages(function(){$rootScope.$broadcast(constantsService.collections.pages+"Changed",pageId),callback&&callback()})},!0)}function getCurrentPage(){return currentPage}function setCurrentPage(newCurrentPage){currentPage=newCurrentPage}function isSubPageOf(subPage,page){return subPage.parentPageId===page._id}function addApp(){var newRowPos=1,rows=getCurrentPage().rows;rowService.addRowAndDependencies(rows,newRowPos),updateCurrentPage(null)}var pages,currentPage;return{loadPages:loadPages,getPages:getPages,getPage:getPage,createPage:createPage,updatePage:updatePage,updateCurrentPage:updateCurrentPage,deletePage:deletePage,getCurrentPage:getCurrentPage,setCurrentPage:setCurrentPage,isSubPageOf:isSubPageOf,addApp:addApp}}])}(window.COMPONENTS),function(COMPONENTS){"use strict";COMPONENTS.factory("portalService",["$compile","$rootScope","pageService","crudService","mediaService","i18nDbService","constantsService","timerService","rowService","colService","domService","arrayService","stdService",function($compile,$rootScope,pageService,crudService,mediaService,i18nDbService,constantsService,timerService,rowService,colService,domService,arrayService,stdService){function setHeader(){setTitle(),setFavicon()}function updatePageDataFromTemplate(portal,pageData){portal.template.rows[1].columns[0].rows=pageData}function loadPortal(portalId,pageId,callback){var bodyObj;portalId&&(bodyObj=$("body"),domService.addLoadingFeedback(bodyObj),crudService.get(constantsService.collections.portal,portalId,null,function(loadedPortal){var pageModel=pageService.getPage(pageId);domService.removeLoadingFeedback(bodyObj),loadedPortal?pageModel?(portal=loadedPortal,updatePageDataFromTemplate(getPortal(),pageModel.rows),pageService.setCurrentPage(pageModel),$rootScope.$broadcast("pageLoaded"),callback&&callback(getPortal())):stdService.error('The page "'+pageId+'" cannot be found'):stdService.error('The portal "'+portalId+'" cannot be found')}))}function getPortal(){return portal}function savePortal(callback){var portalData;portalData=angular.copy(getPortal()),delete portalData.user,updatePageDataFromTemplate(portalData,[]),crudService.update(constantsService.collections.portal,portalData._id,portalData,function(data){$rootScope.$broadcast("onPortalSaved"),setHeader(),callback&&callback(data)})}function setWindowDimensions(){windowDimensions={width:$(window).width(),height:$(window).height()},$(window).resize(function(){($(this).width()!==windowDimensions.width||$(this).height()!==windowDimensions.height)&&(windowDimensions={width:$(this).width(),height:$(this).height()},$rootScope.$broadcast("onWindowResized",windowDimensions))})}function getWindowDimensions(){return windowDimensions}function trackAnalytics(){if(getPortal().trackingCode){var ga,s,_gaq=_gaq||[];_gaq.push(["_setAccount",getPortal().trackingCode]),_gaq.push(["_trackPageview"]),ga=document.createElement("script"),ga.type="text/javascript",ga.async=!0,ga.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",s=document.getElementsByTagName("script")[0],s.parentNode.insertBefore(ga,s)}}function getDefaultFaviconUrl(){return"/client/images/favicon.ico"}function isRealFullscreen(){return"real"===getPortal().fullscreenMode}function isMaximizedFullscreen(){return"maximized"===getPortal().fullscreenMode}function isTemplateFullscreen(){return"template"===getPortal().fullscreenMode}function deleteApp(appElm,appIndex){var columnScope=angular.element(appElm.closest(".columns")).scope(),apps=columnScope.column.apps,rowScope=columnScope.$parent,columns=rowScope.row.columns,rows=rowService.getWrappingRows(rowScope,getPortal().template.rows);arrayService.delete(apps,appIndex),0===apps.length&&(colService.deleteColAndDependencies(columns,columnScope.$index),1!==columns.length||rowService.isTemplateRow(rowScope.row)||rowService.deleteRowAndDependencies(rows,rowScope.$index)),pageService.updateCurrentPage(null),savePortal(null)}function setTitle(){var currentPage=pageService.getCurrentPage();document.title=i18nDbService.getI18nProperty(currentPage.text).text+" | "+getPortal().title}function setDefaultFavicon(){var faviconUrl=getDefaultFaviconUrl();$("#favicon").attr("href",faviconUrl)}function setCustomFavicon(){mediaService.getMediaFromId(getPortal().faviconId,function(favicon){var faviconUrl=mediaService.getDownloadUrl(favicon)+"?v="+timerService.getRandomNumber();$("#favicon").attr("href",faviconUrl)})}function setFavicon(){getPortal().faviconId?setCustomFavicon():setDefaultFavicon()}var portal,windowDimensions;return{setHeader:setHeader,loadPortal:loadPortal,getPortal:getPortal,savePortal:savePortal,updatePageDataFromTemplate:updatePageDataFromTemplate,deleteApp:deleteApp,setWindowDimensions:setWindowDimensions,getWindowDimensions:getWindowDimensions,getDefaultFaviconUrl:getDefaultFaviconUrl,isRealFullscreen:isRealFullscreen,isMaximizedFullscreen:isMaximizedFullscreen,isTemplateFullscreen:isTemplateFullscreen,trackAnalytics:trackAnalytics}}])}(window.COMPONENTS),function(){"use strict";COMPONENTS.factory("roleService",["$rootScope","sessionService","crudService","constantsService",function($rootScope,sessionService,crudService,constantsService){function getRoles(){return indexBasedRoles}function getRole(role){return indexBasedRoles[role]}function loadRoles(callback){var params={sort:{field:"karma",order:"1"}};crudService.get(constantsService.collections.roles,null,params,function(serverRoles){var idx,role={};keyBasedRoles=[];for(idx in serverRoles.results)serverRoles.results.hasOwnProperty(idx)&&(role=serverRoles.results[idx],keyBasedRoles[role.code]={karma:role.karma,title:role.title,description:role.description});indexBasedRoles=serverRoles.results,callback&&callback(getRoles())})}function hasGuestRole(user){return keyBasedRoles?user.role>=keyBasedRoles[constantsService.roles.guest].karma:!1}function hasReaderRole(user){return keyBasedRoles?user.role>=keyBasedRoles[constantsService.roles.reader].karma:!1}function hasCreatorRole(user){return keyBasedRoles?user.role>=keyBasedRoles[constantsService.roles.creator].karma:!1}function hasAdminRole(user){return keyBasedRoles&&user?user.role>=keyBasedRoles[constantsService.roles.admin].karma:!1
}function getAdminAccessStyleClass(){return hasAdminRole(sessionService.getUserSession())?"adminAccess":""}var keyBasedRoles,indexBasedRoles;return{loadRoles:loadRoles,getRoles:getRoles,getRole:getRole,hasGuestRole:hasGuestRole,hasReaderRole:hasReaderRole,hasCreatorRole:hasCreatorRole,hasAdminRole:hasAdminRole,getAdminAccessStyleClass:getAdminAccessStyleClass}}])}(),function(){"use strict";COMPONENTS.factory("sessionService",["$rootScope","$routeParams","ajaxService",function($rootScope,$routeParams,ajaxService){function loadUserSession(callback){ajaxService.ajax({url:"/rest/getSession/",method:"POST",data:{},success:function(loadedUserSession){setUserSession(loadedUserSession),callback&&callback(getUserSession())}})}function getUserSession(){return userSession}function addSessionDataToModel(model){model.create.author=getUserSession(),delete model.create.authorId}function isUserLogged(){return void 0!==getUserSession()}function logout(){window.open("/"+$routeParams.portal+"/logout","_self")}function setUserSession(loadedUserSession){userSession=loadedUserSession?loadedUserSession:null}var userSession;return{loadUserSession:loadUserSession,getUserSession:getUserSession,addSessionDataToModel:addSessionDataToModel,isUserLogged:isUserLogged,logout:logout}}])}(),function(){"use strict";COMPONENTS.factory("tagService",["crudService","constantsService",function(crudService,constantsService){function loadTags(callback){crudService.get(constantsService.collections.tags,null,{},function(tagsObj){tags=tagsObj.results,callback&&callback(getTags())})}function updateTag(tag,callback){var data={text:tag.text};crudService.update(constantsService.collections.tags,tag._id,data,function(updatedTag){callback&&callback(updatedTag)})}function getTags(){return tags}var tags;return{loadTags:loadTags,getTags:getTags,updateTag:updateTag}}])}(),function(){"use strict";COMPONENTS.factory("undeployService",["crudService",function(crudService){function undeploy(appObj,callback){crudService.undeployApp(appObj._id,appObj,function(){callback&&callback()})}return{undeploy:undeploy}}])}(),function(COMPONENTS){"use strict";COMPONENTS.factory("userService",["portalService","sessionService","crudService","$routeParams","constantsService",function(portalService,sessionService,crudService,$routeParams,constantsService){function loadUsers(callback){var params={projection:{password:0}};crudService.get(constantsService.collections.users,null,params,function(returnedUsers){users=returnedUsers.results,callback&&callback(getUsers())})}function getUsers(){return users}function createUser(user,callback){var data;user.fullName||user.email||user.password?(data={fullName:user.fullName,email:user.email,password:user.password,role:user.role,language:user.language,portalId:$routeParams.portal,tags:user.tags},user.media&&user.media._id&&(data.mediaId=user.media._id),crudService.createUser(data,function(newUser){callback&&callback(newUser)})):callback&&callback({})}function updateUser(user,callback){var data;user.fullName||user.email||user.password?(data={fullName:user.fullName,email:user.email,role:user.role,language:user.language,portalId:$routeParams.portal,tags:user.tags},user.media&&user.media._id&&(data.mediaId=user.media._id),user.password&&(data.password=user.password),crudService.updateUser(user._id,data,function(updatedUser){callback&&callback(updatedUser)})):callback&&callback({})}var users;return{loadUsers:loadUsers,getUsers:getUsers,createUser:createUser,updateUser:updateUser}}])}(window.COMPONENTS),function(){"use strict";COMPONENTS.factory("addAppService",["domService",function(domService){function showAddAppPanel(){var addAppPanelObj=$("#addAppPanel"),wrapperObj=$("ul.pages"),collapsedViewObj=$("> .collapsedView",addAppPanelObj),wrapperMarginLeft=domService.getDomPercent(wrapperObj,"margin-left"),wrapperWidth=domService.getDomPercent(wrapperObj,"width"),addAppPanelWidth=domService.getDomPercent(collapsedViewObj,"width");addAppPanelActive=!0,wrapperObj.animate({width:wrapperWidth-addAppPanelWidth+"%",marginLeft:addAppPanelWidth+wrapperMarginLeft+"%",overflow:"visible"},window.speed,function(){}),addAppPanelObj.attr("state","collapsed")}function hideAddAppPanel(){var addAppPanelObj=$("#addAppPanel"),wrapperObj=$("ul.pages"),collapsedViewObj=$("> .collapsedView",addAppPanelObj),wrapperMarginLeft=domService.getDomPercent(wrapperObj,"margin-left"),wrapperWidth=domService.getDomPercent(wrapperObj,"width"),addAppPanelWidth=domService.getDomPercent(collapsedViewObj,"width");addAppPanelActive&&(addAppPanelActive=!1,wrapperObj.animate({width:wrapperWidth+addAppPanelWidth+"%",marginLeft:wrapperMarginLeft-addAppPanelWidth+"%"},window.speed,function(){}),addAppPanelObj.attr("state","hidden"))}function toggleAddAppPanel(){addAppPanelActive?hideAddAppPanel():showAddAppPanel()}function isAddAppPanelActive(){return addAppPanelActive}var addAppPanelActive=!1;return{showAddAppPanel:showAddAppPanel,hideAddAppPanel:hideAddAppPanel,toggleAddAppPanel:toggleAddAppPanel,isAddAppPanelActive:isAddAppPanelActive}}])}(),function(){"use strict";COMPONENTS.factory("appService",["$rootScope","$location","portalService","keyboardService",function($rootScope,$location,portalService,keyboardService){function enableFullscreen(element,_id,currentSize,onResized){isFullscreen()||($("html").addClass("fullscreen"),fullscreen=!0,portalService.isRealFullscreen()?enableRealFullscreen(element,onResized):portalService.isMaximizedFullscreen()?enableMaximizedFullscreen(element,_id):portalService.isTemplateFullscreen()&&enableTemplateFullscreen(element,_id,currentSize),triggerOnResizeEvent(onResized),registerKeyboardEvents(element,onResized))}function disableFullscreen(element,onResized){$("html").removeClass("fullscreen"),fullscreen=!1,portalService.isRealFullscreen()?disableRealFullscreen(element):portalService.isMaximizedFullscreen()?disableMaximizedFullscreen(element):portalService.isTemplateFullscreen()&&disableTemplateFullscreen(element),triggerOnResizeEvent(onResized),unregisterKeyboardEvents()}function isFullscreen(){return fullscreen}function triggerOnResizeEvent(onResized){onResized&&setTimeout(function(){onResized()},100)}function enableRealFullscreen(element,onResized){$("html").addClass("appRealFullscreen"),element.addClass("realFullscreen"),element.fullScreen(!0),$(document).bind("fullscreenchange",function(){$(document).fullScreen()||disableFullscreen(element,onResized)})}function disableRealFullscreen(element){$("html").removeClass("appRealFullscreen"),element.removeClass("realFullscreen"),element.fullScreen(!1),$(document).unbind("fullscreenchange")}function enableMaximizedFullscreen(element,_id){$("html").addClass("appMaximizedFullscreen"),element.addClass("maximizedFullscreen"),updateSearchId(_id)}function disableMaximizedFullscreen(element){$("html").removeClass("appMaximizedFullscreen"),element.removeClass("maximizedFullscreen"),updateSearchId(null)}function enableTemplateFullscreen(element,_id,currentSize){var columns=element.closest(".columns");columns.addClass("colFullscreen large-23"),columns.prev(".columns").addClass("colFullscreen"),columns.next(".columns").addClass("colFullscreen"),previousSize=currentSize,$("html").addClass("appTemplateFullscreen"),element.addClass("templateFullscreen"),updateSearchId(_id)}function disableTemplateFullscreen(element){$(".colFullscreen.large-23").removeClass("large-23").addClass("large-"+previousSize),$(".colFullscreen").removeClass("colFullscreen"),$("html").removeClass("appTemplateFullscreen"),element.removeClass("templateFullscreen"),updateSearchId(null)}function registerKeyboardEvents(element,onResized){keyboardService.register("esc",directiveId,function(){disableFullscreen(element,onResized),$rootScope.$apply()})}function unregisterKeyboardEvents(){keyboardService.unregister("esc",directiveId)}function updateSearchId(_id){$location.search("_id",_id)}var fullscreen,previousSize,directiveId="app";return{enableFullscreen:enableFullscreen,disableFullscreen:disableFullscreen,isFullscreen:isFullscreen,triggerOnResizeEvent:triggerOnResizeEvent}}])}(),function(){"use strict";COMPONENTS.factory("resizableAppService",["portalService","pageService","rowService",function(portalService,pageService,rowService){function start(resizingDomObj,event){var row=resizingDomObj.closest(".rows"),size=row.width()/cols;previousSize=resizingDomObj.width(),resizingColumnScope=angular.element(resizingDomObj).scope(),setAffectedColumn(resizingDomObj,event),resizingDomObj.resizable("option","grid",size)}function resize(resizingDomObj){var hasBeenReduced=resizingDomObj.width()<previousSize;affectedColumn&&setNewColSizes(hasBeenReduced),previousSize=resizingDomObj.width(),resizingDomObj.removeAttr("style"),resizingColumnScope.$parent.$apply(),pageService.updateCurrentPage(null),portalService.savePortal(null)}function setAffectedColumn(resizingDomObj,event){var index=resizingColumnScope.$index;event.clientX>resizingDomObj.offset().left+resizingDomObj.width()/2?setNextAffectedColumn(index):setPrevAffectedColumn(index)}function setNextAffectedColumn(resizingColumnIndex){var nextColumn=resizingColumnScope.$parent.row.columns[resizingColumnIndex+1];affectedColumn=shouldResizeNextColumn(resizingColumnIndex,nextColumn)?nextColumn:resizingColumnScope.$parent.row.columns[resizingColumnIndex+2]}function setPrevAffectedColumn(resizingColumnIndex){var prevColumn=resizingColumnScope.$parent.row.columns[resizingColumnIndex-1];affectedColumn=shouldResizePrevColumn(resizingColumnIndex,prevColumn)?prevColumn:resizingColumnScope.$parent.row.columns[resizingColumnIndex-2]}function shouldResizePrevColumn(resizingColumnIndex,prevColumn){return 1===resizingColumnIndex||prevColumn.size>1}function shouldResizeNextColumn(resizingColumnIndex,nextColumn){return resizingColumnIndex===resizingColumnScope.$parent.row.columns.length-2||nextColumn.size>1}function setNewColSizes(hasBeenReduced){hasBeenReduced&&resizingColumnScope.column.size>1?(resizingColumnScope.column.size=resizingColumnScope.column.size-1,affectedColumn.size=affectedColumn.size+1):affectedColumn.size>1&&(resizingColumnScope.column.size=resizingColumnScope.column.size+1,affectedColumn.size=affectedColumn.size-1)}var previousSize,resizingColumnScope,affectedColumn,cols=rowService.getMaxSlots();return{start:start,resize:resize}}])}(),function(){"use strict";COMPONENTS.factory("sortableAppService",["$rootScope","$timeout","portalService","pageService","rowService","colService","arrayService","keyboardService","timerService",function($rootScope,$timeout,portalService,pageService,rowService,colService,arrayService,keyboardService,timerService){function start(ui){$("html").addClass("sorting"),originalElm=$(ui.item).parent(),isUpdateBlocked=!$(ui.item).hasClass("new"),registerKeyboardEvents()}function update(ui){setOptions(originalElm,$(ui.item)),isUpdateTime()&&(updateIfThereIsSpace(),$rootScope.$$phase||$rootScope.$apply()),isUpdateBlocked=!1}function stop(){unregisterKeyboardEvents(),$("html").removeClass("sorting")}function isUpdateTime(){return colService.areSameCol(options.originalCol,options.dropCol)||!isUpdateBlocked||options.isNewItem}function registerKeyboardEvents(){keyboardService.register("esc","sortableApp",function(){$("[sortable-app]").trigger("mouseup")})}function unregisterKeyboardEvents(){keyboardService.unregister("esc","sortableApp")}function updateIfThereIsSpace(){rowService.isAvailableSpaceInRow(options.dropRow,options.dropCol,options.affectedDropCol)?$timeout(function(){executeUpdate()},0):blockUpdate()}function setOptions(originalElm,droppedElm){var wrappingRows=portalService.getPortal().template.rows;return options={},options.isNewItem=void 0!==droppedElm.attr("sortable-add-app"),options.wrapperOriginalRowScope=angular.element(originalElm.closest(".rows")).scope(),options.wrapperDropRowScope=angular.element(droppedElm.closest(".rows")).scope(),options.originalRows=rowService.getWrappingRows(options.wrapperOriginalRowScope,wrappingRows),options.dropRows=rowService.getWrappingRows(options.wrapperDropRowScope,wrappingRows),options.droppedElm=droppedElm,options.originalColIndex=originalElm.closest(".columns").prevAll(".columns").size(),options.dropColIndex=droppedElm.closest(".columns").prevAll(".columns").size(),options.originalRowIndex=originalElm.closest(".rows").prevAll(".rows").size(),options.originalAppIndex=originalElm.prevAll(".app").size(),options.dropRowIndex=droppedElm.closest(".rows").prevAll(".rows").size(),options.dropAppIndex=droppedElm.prevAll(".app").size(),options.originalRow=originalElm.closest(".rows").scope().row,options.dropRow=droppedElm.closest(".rows").scope().row,options.dropCol=options.dropRow.columns[options.dropColIndex],options.originalCol=options.originalRow.columns[options.originalColIndex],options.elmHasChangedRow=options.originalRow.$$hashKey!==options.dropRow.$$hashKey,options.affectedDropCol=colService.getAffectedCol(options.dropRow.columns,options.dropColIndex),options.affectedOriginalCol=options.elmHasChangedRow?colService.getAffectedCol(options.originalRow.columns,options.originalColIndex):options.affectedDropCol,options}function blockUpdate(){deleteNewDroppedElm(options.dropCol,options.droppedElm,options.dropAppIndex),$timeout(function(){arrayService.delete(options.dropCol.apps,options.dropAppIndex)})}function executeUpdate(){options.isNewItem&&deleteNewDroppedElm(options.dropCol,options.droppedElm,options.dropAppIndex),updateConsideringRowChange(),decorateDropRow(),deleteGhostApp(),pageService.updateCurrentPage(null),portalService.savePortal(null)}function updateConsideringRowChange(){(options.isNewItem||1===options.dropCol.apps.length||0===options.originalCol.apps.length)&&(options.isNewItem||options.elmHasChangedRow?updateWithRowChange():updateWithoutRowChange())}function updateWithRowChange(){rowService.isDropRowEmpty(options.dropRow)&&!rowService.isTemplateRow(options.wrapperDropRowScope.row)&&addEmptyRows(),options.affectedDropCol&&options.dropCol.apps.length>0?updateWithRowChangeNonEmptyOriginalColumn():options.affectedOriginalCol&&updateWithRowChangeEmptyOriginalColumn()}function updateWithRowChangeEmptyOriginalColumn(){var availableWidth=options.affectedOriginalCol.size+options.originalCol.size;options.affectedOriginalCol.size=availableWidth+1}function updateWithRowChangeNonEmptyOriginalColumn(){var availableWidth=options.dropCol.size+options.affectedDropCol.size;options.dropCol.size=Math.ceil(availableWidth/2)+1,options.affectedDropCol.size=Math.floor(availableWidth/2)-1,options.affectedOriginalCol&&!options.originalCol.apps.length&&(availableWidth=options.affectedOriginalCol.size+options.originalCol.size,options.affectedOriginalCol.size=availableWidth+1)}function updateWithoutRowChange(){options.affectedDropCol&&options.originalCol.apps.length?updateWithoutRowChangeNonEmptyOriginalColumn():updateWithoutRowChangeEmptyOriginalColumn()}function updateWithoutRowChangeEmptyOriginalColumn(){var availableWidth=options.dropCol.size+options.originalCol.size;options.dropCol.size=availableWidth+1}function updateWithoutRowChangeNonEmptyOriginalColumn(){var availableWidth=options.dropCol.size+options.affectedDropCol.size;options.affectedDropCol.$$hashKey!==options.dropCol.$$hashKey&&(options.dropCol.size=Math.ceil(availableWidth/2)+1,options.affectedDropCol.size=Math.floor(availableWidth/2)-1)}function addEmptyRows(){rowService.addEmptyRow(options.dropRows,options.dropRowIndex),rowService.addEmptyRow(options.dropRows,options.dropRowIndex+2),options.dropRowIndex<options.originalRowIndex&&(options.originalRowIndex+=2)}function decorateDropRow(){1===options.dropCol.apps.length&&colService.addEmptyCols(options.dropRow,options.dropCol,options.dropColIndex),colService.normalizeEmptyCols(options.originalRow),rowService.isOriginalRowEmpty(options.originalRow)&&!rowService.isTemplateRow(options.wrapperOriginalRowScope.row)&&rowService.deleteRowAndDependencies(options.originalRows,options.originalRowIndex)}function deleteGhostApp(){options.droppedElm.siblings("[app]:not(:empty)").size()+1>options.dropCol.apps.length&&options.droppedElm.remove()}function deleteNewDroppedElm(dropCol,droppedElm,dropAppIndex){dropCol.apps.forEach(function(item,index){item||arrayService.delete(dropCol.apps,index)}),arrayService.add(dropCol.apps,{type:droppedElm.attr("type"),id:timerService.getRandomNumber()},dropAppIndex),droppedElm.remove()}var originalElm,options,isUpdateBlocked=!1;return{start:start,update:update,stop:stop}}])}(),function(){"use strict";COMPONENTS.factory("emailService",["ajaxService",function(ajaxService){function validateEmail(email){var re=/\S+@\S+\.\S+/;return re.test(email)}function sendEmail(data,callback){ajaxService.ajax({url:"/rest/sendEmail",method:"POST",data:data,success:function(response){callback&&callback(response)}})}return{validateEmail:validateEmail,sendEmail:sendEmail}}])}(),function(io){"use strict";COMPONENTS.factory("liveMessageService",[function(){function sendPublicMessage(data,callback){socket.emit("publicMessage",data,function(result){callback&&callback(result)})}var socket=io.connect(window.location.origin);return socket.on("publicMessageReceived",function(data){alert("msg received"+data.text+" - "+data.details)}),{sendPublicMessage:sendPublicMessage}}])}(window.io),function(){"use strict";COMPONENTS.factory("globalMsgService",[function(){function show(text,details){onShowObservers.forEach(function(onShowObserver){onShowObserver(text,details)})}function hide(){onHideObservers.forEach(function(onHideObserver){onHideObserver()})}function onShow(observer){onShowObservers.push(observer)}function onHide(observer){onHideObservers.push(observer)}var onShowObservers=[],onHideObservers=[];return{show:show,hide:hide,onShow:onShow,onHide:onHide}}])}(),function(){"use strict";COMPONENTS.factory("loadingService",[function(){function start(){NProgress.start()}function done(){NProgress.done()}return NProgress.configure({trickleRate:.1,trickleSpeed:0}),{start:start,done:done}}])}(),function(){"use strict";COMPONENTS.factory("stdService",["globalMsgService",function(globalMsgService){function warn(text,details){console.warn("[WARN] "+text,details)}function error(text,details){console.error("[ERROR] "+text,details),globalMsgService.show(text,details)}function todo(text){console.log("[TODO] "+text)}return{warn:warn,error:error,todo:todo}}])}(),function(){"use strict";COMPONENTS.factory("i18nDbService",["i18nService","objectService",function(i18nService,objectService){function getI18nProperty(obj){var currentLanguage=i18nService.getCurrentLanguage(),defaultLanguage=i18nService.getDefaultLanguage();return obj&&objectService.isObject(obj)?obj[currentLanguage]||obj[defaultLanguage]:{text:obj}}function hasI18nStructure(obj){var currentLanguage=i18nService.getCurrentLanguage();return obj&&void 0!==obj[currentLanguage]}function setInitI18nStructure(obj){var objText=obj;return obj={},obj[i18nService.getDefaultLanguage()]={text:objText},obj}return{getI18nProperty:getI18nProperty,hasI18nStructure:hasI18nStructure,setInitI18nStructure:setInitI18nStructure}}])}(),function(){"use strict";COMPONENTS.factory("i18nService",["$rootScope","crudService","constantsService",function($rootScope,crudService,constantsService){function getBrowserLanguage(){return(navigator.language||navigator.userLanguage).split("-")[0]}function i18n(){return $.i18n.prop.apply($.i18n,arguments)}var languages,userLanguage=getBrowserLanguage(),defaultLanguage="en",settings={name:"messages",path:"/client/messages/",mode:"map",language:userLanguage,callback:function(){}};return $.i18n.properties(settings),i18n.loadLanguages=function(callback){crudService.get(constantsService.collections.languages,null,{},function(loadedLanguages){languages=loadedLanguages.results,callback&&callback(i18n.getLanguages())})},i18n.getLanguages=function(){return languages},i18n.getCurrentLanguage=function(){return settings.language},i18n.getDefaultLanguage=function(){return defaultLanguage},i18n.changeLanguage=function(langCode){langCode!==settings.language&&(settings.language=langCode,$.i18n.properties(settings),$rootScope.$broadcast("languageChanged",langCode))},i18n}])}(),function(){"use strict";COMPONENTS.factory("colService",["$rootScope","rowService","arrayService",function($rootScope,rowService,arrayService){function normalizeEmptyCols(row){for(var i=0;i<row.columns.length;i+=1)normalizeEmptyCol(row.columns,i)&&normalizeEmptyCols(row);1===row.columns.length&&(row.columns[0].size=rowService.getMaxSlots())}function addEmptyCols(dropRow,dropCol,dropColIndex){arrayService.add(dropRow.columns,getEmptyCol(),dropColIndex),arrayService.add(dropRow.columns,getEmptyCol(),dropColIndex+2),dropCol.size=dropCol.size-=2}function deleteColAndDependencies(columns,columnIndex){var availableWidth,affectedCol=getAffectedCol(columns,columnIndex);affectedCol&&(availableWidth=columns[columnIndex].size+affectedCol.size,affectedCol.size=availableWidth+1),arrayService.delete(columns,columnIndex),arrayService.delete(columns,columnIndex),affectedCol||(columns[0].size=rowService.getMaxSlots())}function getAffectedCol(columns,dropColIndex){var affectedDropCol;return affectedDropCol=getAffectedNextCol(columns,dropColIndex),affectedDropCol||(affectedDropCol=getAffectedPrevCol(columns,dropColIndex)),affectedDropCol}function getEmptyCol(){return{size:1,apps:[]}}function areSameCol(column1,column2){return column1.$$hashKey===column2.$$hashKey}function getAffectedNextCol(columns,dropColIndex){var affectedDropCol,i;for(i=dropColIndex+1;i<columns.length;i+=1)if(columns[i].size>=3){affectedDropCol=columns[i];break}return affectedDropCol}function getAffectedPrevCol(columns,dropColIndex){var affectedDropCol,i;for(i=dropColIndex-1;i>=0;i-=1)if(columns[i].size>=3){affectedDropCol=columns[i];break}return affectedDropCol}function normalizeEmptyCol(cols,colIndex){var col=cols[colIndex],nextCol=cols[colIndex+1];return 0===col.apps.length&&col.size>1&&(col.size=1),nextCol&&0===col.apps.length&&0===nextCol.apps.length?(arrayService.delete(cols,colIndex),!0):null}return{normalizeEmptyCols:normalizeEmptyCols,addEmptyCols:addEmptyCols,deleteColAndDependencies:deleteColAndDependencies,getAffectedCol:getAffectedCol,getEmptyCol:getEmptyCol,areSameCol:areSameCol}}])}(),function(){"use strict";COMPONENTS.factory("rowService",["arrayService",function(arrayService){function getMaxSlots(){return maxSlots}function isAvailableSpaceInRow(dropRow,dropCol,affectedDropCol){return affectedDropCol||1===dropRow.columns.length||dropCol.apps.length>1}function isOriginalRowEmpty(originalRow){return 1===originalRow.columns.length&&0===originalRow.columns[0].apps.length}function isDropRowEmpty(dropRow){return 1===dropRow.columns.length&&1===dropRow.columns[0].apps.length}function addRowAndDependencies(rows,newRowPos){var newRow={columns:[{size:1,apps:[]},{size:getMaxSlots()-2,apps:[{type:"menuApp"}]},{size:1,apps:[]}]};arrayService.add(rows,newRow,newRowPos),addEmptyRow(rows,newRowPos+1)}function addEmptyRow(rows,dropRowIndex){arrayService.add(rows,getEmptyRow(),dropRowIndex)}function getEmptyRow(){return{columns:[{size:getMaxSlots(),apps:[]}]}}function deleteRowAndDependencies(rows,rowIndex){rows.length>1&&arrayService.delete(rows,rowIndex),rows.length>1&&arrayService.delete(rows,rowIndex)}function getWrappingRows(rowScope,rows){return rowScope.row.template?rows:rows[1].columns[0].rows}function isTemplateRow(row){return row.template}var maxSlots=25;return{getMaxSlots:getMaxSlots,isAvailableSpaceInRow:isAvailableSpaceInRow,isOriginalRowEmpty:isOriginalRowEmpty,isDropRowEmpty:isDropRowEmpty,addRowAndDependencies:addRowAndDependencies,addEmptyRow:addEmptyRow,getEmptyRow:getEmptyRow,deleteRowAndDependencies:deleteRowAndDependencies,getWrappingRows:getWrappingRows,isTemplateRow:isTemplateRow}}])}(),function(Array){"use strict";COMPONENTS.factory("arrayService",[function(){function isArray(obj){return obj instanceof Array}function add(array,element,index){return array.splice(index,0,element),array}function copy(sourceArray,startIndex,length){var i,destArray=[];for(startIndex=startIndex||0,length=length||sourceArray.length,i=startIndex;startIndex+length>i;i+=1)destArray.push(sourceArray[i]);return destArray}function move(array,oldIndex,newIndex){if(newIndex>=array.length)for(var k=newIndex-array.length;(k-=1)+1;)array.push(void 0);return array.splice(newIndex,0,array.splice(oldIndex,1)[0]),array}function remove(array,index){return array.splice(index,1),array}return{isArray:isArray,add:add,copy:copy,move:move,"delete":remove}}])}(window.Array),function(){"use strict";COMPONENTS.factory("canvasService",[function(){function getCoordinates(canvasObj,canvasElm){var scaleX=canvasElm.scaleX||1,scaleY=canvasElm.scaleY||1,canvasElmWidth=canvasElm.width*scaleX,canvasElmHeight=canvasElm.height*scaleY;return{top:canvasObj.offset().top+canvasElm.top-canvasElmHeight/2,left:canvasElm.left-canvasElmWidth/2,width:canvasElmWidth,height:canvasElmHeight}}return{getCoordinates:getCoordinates}}])}(),function(COMPONENTS){"use strict";COMPONENTS.factory("dateService",[function(){function getFormattedDate(date){function normalizeDateToken(token){return("0"+token).slice(-2)}var dateObj,day,month,year;return dateObj=new Date(date),day=normalizeDateToken(dateObj.getDate()),month=normalizeDateToken(dateObj.getMonth()+1),year=dateObj.getFullYear(),day+"-"+month+"-"+year}return{getFormattedDate:getFormattedDate}}])}(window.COMPONENTS),function(){"use strict";COMPONENTS.factory("domService",[function(){function getCoordinates(obj){return{top:obj.position().top,left:obj.position().left,width:obj.outerWidth(),height:obj.outerHeight()}}function getObjPadding(obj){return{top:parseInt(obj.css("paddingTop"),10),right:parseInt(obj.css("paddingRight"),10),bottom:parseInt(obj.css("paddingBottom"),10),left:parseInt(obj.css("paddingLeft"),10)}}function getElementType(obj){return obj[0].tagName.toLowerCase()}function getDomPercent(dest,cssProperty){return dest instanceof jQuery||(dest=$(dest)),Math.round(100*parseInt(dest.css(cssProperty),10)/$("html").width())}function addLoadingFeedback(domObject){domObject.addClass("loading")}function removeLoadingFeedback(domObject){domObject.removeClass("loading")}return{getCoordinates:getCoordinates,getObjPadding:getObjPadding,getElementType:getElementType,getDomPercent:getDomPercent,addLoadingFeedback:addLoadingFeedback,removeLoadingFeedback:removeLoadingFeedback}}])}(),function(){"use strict";COMPONENTS.factory("editBoxUtilsService",["$compile","domService","keyboardService",function($compile,domService,keyboardService){function showEditBox(scope,element,selectedTextDomObj){function setTargetSettings(){element.parent().css("position","relative"),scope.target={id:scope.$id,element:element,coordinates:selectedTextDomObj?domService.getCoordinates(selectedTextDomObj):domService.getCoordinates(element)}}function setArrowPos(){function isTargetObjLeftPlaced(){return selectedTextDomObj.offset().left+scope.target.coordinates.width<$(window).width()/2}scope.arrowPos=isTargetObjLeftPlaced()?"left":"right"}function addEditBoxToDom(){scope.model||(scope.model={});var editBoxObj,parentEditBoxObj;editBoxObj=$('<edit-box model="model" panels="panels" arrow-pos="arrowPos" internal-data="internalData" on-save="onSave" on-change="onChange" on-cancel="onCancel" on-close="onClose" target="target"></edit-box>'),parentEditBoxObj=element.closest(".editBox"),parentEditBoxObj.size()&&editBoxObj.addClass("child"),element.after(editBoxObj),$compile(editBoxObj)(scope)}function safeUnblockEditBox(){setTimeout(function(){isMoving||unblockHideEditBox()},100)}setTargetSettings(),setArrowPos(),blockHideEditBox(),addEditBoxToDom(),safeUnblockEditBox()}function hideEditBox(textBoxId){function unregisterKeyboardEvents(){keyboardService.unregister("esc",serviceId),keyboardService.unregister("left","edit"),keyboardService.unregister("right","edit")}isHideActionBlocked||(textBoxId?$("#editBox"+textBoxId).remove():$(".editBox").remove()),unregisterKeyboardEvents()}function isEditBoxVisible(){return $(".editBox").size()>0}function isEditBoxClicked(event){return $(event.target).closest(".editBox").size()>0}function blockHideEditBox(){isHideActionBlocked=!0}function unblockHideEditBox(){isHideActionBlocked=!1}var isHideActionBlocked=!1,isMoving=!1,serviceId="editBoxUtilsService";return{showEditBox:showEditBox,hideEditBox:hideEditBox,isEditBoxVisible:isEditBoxVisible,isEditBoxClicked:isEditBoxClicked,blockHideEditBox:blockHideEditBox,unblockHideEditBox:unblockHideEditBox}}])}(),function(Mousetrap){"use strict";COMPONENTS.factory("keyboardService",["arrayService","stringService","constantsService",function(arrayService,stringService,constantsService){function register(shortcut,source,bindFn){function stackAndBind(shortcut,source,bindFn){var normalizedShortcut=normalizeShortcut(shortcut);bindFns[normalizedShortcut]||(bindFns[normalizedShortcut]=[]),bindFns[normalizedShortcut].push({fn:bindFn,source:source}),bind(normalizedShortcut,bindFn)}arrayService.isArray(shortcut)?shortcut.forEach(function(shortcutInstance){stackAndBind(shortcutInstance,source,bindFn)}):stackAndBind(shortcut,source,bindFn)}function unregister(shortcut,source){function unstackAndUnbind(shortcut,source){var normalizedShortcut=normalizeShortcut(shortcut),bindFnsShortcut=bindFns[normalizedShortcut];bindFnsShortcut&&bindFnsShortcut[bindFnsShortcut.length-1]&&source===bindFnsShortcut[bindFnsShortcut.length-1].source&&(arrayService.delete(bindFnsShortcut,bindFnsShortcut.length-1),unbind(normalizedShortcut))}arrayService.isArray(shortcut)?shortcut.forEach(function(shortcutInstance){unstackAndUnbind(shortcutInstance,source)}):unstackAndUnbind(shortcut,source)}function bind(shortcut,bindFn){var normalizedBindFn=function(){return blockShortcut||(bindFn(),blockShortcut=!0,setTimeout(function(){blockShortcut=!1},constantsService.keyboardInterval)),!1};Mousetrap.bind(shortcut,normalizedBindFn)}function unbind(shortcut){var bindFnsShortcut=bindFns[shortcut];Mousetrap.unbind(shortcut),bindFnsShortcut.length&&bind(shortcut,bindFnsShortcut[bindFnsShortcut.length-1].fn)}function normalizeShortcut(shortcut){return stringService.replaceToken(shortcut," ","")}var bindFns=[],blockShortcut=!1;return{register:register,unregister:unregister}}])}(window.Mousetrap),function(){"use strict";COMPONENTS.factory("mediaService",["crudService","constantsService",function(crudService,constantsService){function createMedia(mediaList,callback){var processedItems=0;mediaList.forEach(function(media){media.tags=mediaList.tags,updateMedia(media,function(newMedia){processedItems+=1,callback&&processedItems===mediaList.length&&callback(newMedia)})})}function updateMedia(media,callback){var data;media?(data={name:media.name,tags:media.tags},crudService.update(constantsService.collections.media,media._id,data,function(newMedia){callback&&callback(newMedia)})):callback&&callback({})}function getMediaFromId(mediaId,callback){var params={projection:{data:0}};crudService.get(constantsService.collections.media,mediaId,params,function(media){callback&&callback(media)})}function getDownloadUrl(media){return media&&media._id?"/media/"+media._id+"/"+media.name:null}function getMediaHtmlDetails(media){function getFriendlyMediaSize(size){function normalizeDecimals(size){return Math.floor(10*size)/10}var friendlyMediaSize,gB=1073741824,mB=1048576,kB=1024;return friendlyMediaSize=size>gB?normalizeDecimals(size/gB)+" GB":size>mB?normalizeDecimals(size/mB)+" MB":size>kB?normalizeDecimals(size/kB)+" KB":size+" bytes"}if(media&&media._id){var downloadUrl=getDownloadUrl(media),size=getFriendlyMediaSize(media.size),dimensions=media.width+"x"+media.height;return'<a href="'+downloadUrl+'" target="_blank">'+media.name+"</a><br/>("+dimensions+", "+size+")"}}function getDefaultAvatarUrl(){return"/client/images/user.svg"}return{createMedia:createMedia,updateMedia:updateMedia,getMediaFromId:getMediaFromId,getDownloadUrl:getDownloadUrl,getMediaHtmlDetails:getMediaHtmlDetails,getDefaultAvatarUrl:getDefaultAvatarUrl}}])}(),function(){"use strict";
COMPONENTS.factory("objectService",[function(){function isObject(item){return"object"==typeof item}return{isObject:isObject}}])}(),function(){"use strict";COMPONENTS.factory("stringService",[function(){function replaceToken(string,sourceToken,targetToken){var re=new RegExp(sourceToken,"g");return string?string.replace(re,targetToken):""}function capitalize(string){return string.charAt(0).toUpperCase()+string.slice(1)}function decapitalize(string){return string.charAt(0).toLowerCase()+string.slice(1)}function toSnakeCase(string){return string.replace(/[A-Z]/g,function(letter,pos){return(pos?"-":"")+letter.toLowerCase()})}function toCamelCase(string){return string.replace(/([\:\-\_]+(.))/g,function(_,separator,letter,offset){return offset?letter.toUpperCase():letter}).replace(/^moz([A-Z])/,"Moz$1")}function trim(string){return $.trim(string)}function isEmpty(string){return""===string||null===string||void 0===string}return{replaceToken:replaceToken,capitalize:capitalize,decapitalize:decapitalize,toSnakeCase:toSnakeCase,toCamelCase:toCamelCase,trim:trim,isEmpty:isEmpty}}])}(),function(){"use strict";COMPONENTS.factory("styleService",["stringService",function(stringService){function getNormalizedStyles(sourceMdl,destMdl){var styleKey,styleValue;destMdl||(destMdl={});for(styleKey in sourceMdl)sourceMdl.hasOwnProperty(styleKey)&&(styleValue=sourceMdl[styleKey],styleValue&&(destMdl[styleKey]=sourceMdl[styleKey]));return destMdl}function getComputedStyleInRange(rootObj,leafObj){for(var styleObj,stylePropArray,stylePropIndex,styleKeyValueArray,stylesArrayIndex,normalizedKey,normalizedValue,stylesArray=[],stylesObj={};leafObj[0]!==rootObj[0];){if(styleObj={},void 0!==leafObj.attr("style")){stylePropArray=leafObj.attr("style").split(";");for(stylePropIndex in stylePropArray)stylePropArray.hasOwnProperty(stylePropIndex)&&(styleKeyValueArray=stylePropArray[stylePropIndex].split(":"),""!==styleKeyValueArray[0]&&void 0!==styleKeyValueArray[0]&&(normalizedKey=stringService.trim(stringService.toCamelCase(styleKeyValueArray[0])),normalizedValue=stringService.trim(styleKeyValueArray[1]),styleObj[normalizedKey]=normalizedValue));stylesArray.unshift(styleObj)}leafObj=leafObj.parent()}for(stylesArrayIndex in stylesArray)stylesArray.hasOwnProperty(stylesArrayIndex)&&(stylesObj=$.extend(!0,stylesObj,stylesArray[stylesArrayIndex]));return stylesObj}function rgbStrToRgbObj(rgbStr){var beginIdx=rgbStr.indexOf("(")+1,endIdx=rgbStr.indexOf(")")-rgbStr.indexOf("(")-1,rgbArray=rgbStr.substr(beginIdx,endIdx).split(",");return 3===rgbArray.length?{r:Number(stringService.trim(rgbArray[0])),g:Number(stringService.trim(rgbArray[1])),b:Number(stringService.trim(rgbArray[2]))}:null}function rgbObjToHexStr(rgbObj){function componentToHex(c){var hex=c.toString(16);return 1===hex.length?"0"+hex:hex}return("#"+componentToHex(rgbObj.r)+componentToHex(rgbObj.g)+componentToHex(rgbObj.b)).toUpperCase()}return{getNormalizedStyles:getNormalizedStyles,getComputedStyleInRange:getComputedStyleInRange,rgbStrToRgbObj:rgbStrToRgbObj,rgbObjToHexStr:rgbObjToHexStr}}])}(),function(){"use strict";COMPONENTS.factory("textSelectionService",[function(){function saveSelection(){savedSel=rangyPlgn.saveSelection()}function setFakeSelection(){var selectedTextDomObj=getSelectedTextDomObj();selectedTextDomObj.attr("fakeSelection","true")}function getSelectedTextDomObj(){rangyPlgn.init();var randomCssClass="rangyTemp_"+ +new Date,classApplier=rangyPlgn.createCssClassApplier(randomCssClass,!0);return classApplier.applyToSelection(),$("."+randomCssClass).removeClass(randomCssClass)}function isSelection(){var sel=rangyPlgn.getSelection();return sel._ranges.length>0&&sel._ranges[0].startOffset!=sel._ranges[0].endOffset}function isFakeSelection(){return $("[fakeSelection]").size()>0}function setStylesToSelection(styles){var selectedTextDomObj=getSelectedTextDomObj();selectedTextDomObj.css(styles)}function restoreSelection(){savedSel&&rangyPlgn.restoreSelection(savedSel),saveSelection()}function setLink(linkOptions){restoreSelection();var existingLinkObj=getSelectedTextDomObj().closest("."+linkKey),existsLink=existingLinkObj.length>0;if(existsLink)existingLinkObj.attr(linkOptions);else{var classApplier=rangyPlgn.createCssClassApplier(linkKey,{elementTagName:"a",elementProperties:linkOptions});classApplier.applyToSelection()}restoreSelection()}function getSelectedLinkDomObj(){return getSelectedTextDomObj().closest("."+linkKey)}function removeSelection(){var sel=rangyPlgn.getSelection();if(isSelection()||isFakeSelection()){sel.removeAllRanges();var fakeSelectionObj=$("[fakeSelection]");""===fakeSelectionObj.attr("style")?fakeSelectionObj.replaceWith(fakeSelectionObj.html()):fakeSelectionObj.removeAttr("fakeSelection")}}var savedSel=!1,rangyPlgn=rangy,linkKey="link";return{saveSelection:saveSelection,setFakeSelection:setFakeSelection,getSelectedTextDomObj:getSelectedTextDomObj,isSelection:isSelection,isFakeSelection:isFakeSelection,setStylesToSelection:setStylesToSelection,restoreSelection:restoreSelection,removeSelection:removeSelection,setLink:setLink,getSelectedLinkDomObj:getSelectedLinkDomObj}}])}(),function(clearInterval){"use strict";COMPONENTS.factory("timerService",[function(){function updateInterval(transitionTimer,method,timer){return clearInterval(transitionTimer),transitionTimer=setInterval(method,timer)}function getRandomNumber(){var now=new Date;return now.getTime()}return{updateInterval:updateInterval,getRandomNumber:getRandomNumber}}])}(window.clearInterval),function(undefined){"use strict";COMPONENTS.factory("validationService",[function(){function isFormValid(formObjs){function validateForm(formObj){return formObj.$pristine||formObj.$dirty&&formObj.$valid}var isValid=!0;return $.isArray(formObjs)?formObjs.forEach(function(formObj){isValid*=validateForm(formObj)}):isValid=validateForm(formObjs),isValid}function setFocusOnFirstError(wrapperObj){$(".ng-invalid[ng-model]:first",wrapperObj).focus().addClass("forceMessage")}function setupValidation(defValue,element,ctrl,errorTitle,errorHtmlDetails,validationKey,validationFn){function addHelpMessage(inputObj,errorTitle,errorHtmlDetails){inputObj.data("decorated")||(inputObj.wrap('<div class="positionRelative"></div>'),inputObj.after('<div class="input-help"></div>'),setHelpMessageContent(inputObj,errorTitle,errorHtmlDetails)),inputObj.data("decorated",!0)}function updateHelpMessage(inputObj,errorTitle,errorHtmlDetails){setHelpMessageContent(inputObj,errorTitle,errorHtmlDetails)}function setHelpMessageContent(inputObj,errorTitle,errorHtmlDetails){var detailsObj,inputHelpObj=inputObj.next(".input-help");inputHelpObj.empty(),inputHelpObj.prepend('<div class="title">'+errorTitle+"</div>"),errorHtmlDetails&&(detailsObj=$('<div class="details"></div>'),inputHelpObj.append(detailsObj),detailsObj.html(errorHtmlDetails))}addHelpMessage(element,errorTitle,errorHtmlDetails),ctrl.$setValidity(validationKey,validationFn(defValue));var validator=function(newValue){return validationFn(newValue)?(ctrl.$setValidity(validationKey,!0),newValue):(ctrl.$setValidity(validationKey,!1),updateHelpMessage(element,errorTitle,errorHtmlDetails),undefined)};ctrl.$formatters.push(validator),ctrl.$parsers.unshift(validator)}return{isFormValid:isFormValid,setFocusOnFirstError:setFocusOnFirstError,setupValidation:setupValidation}}])}(window.undefined);